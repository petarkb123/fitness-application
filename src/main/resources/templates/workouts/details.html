<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FitPower - Workout Details</title>
    <link rel="stylesheet" th:href="@{/css/desktop/details.css}">
    <link rel="stylesheet" th:href="@{/css/mobile/details-mobile.css}" media="(max-width: 480px)">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body>
<div class="dashboard-container">
    
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <i class="fas fa-dumbbell"></i>
                <span>FitPower</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">MAIN MENU</h3>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/dashboard" class="nav-link">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/exercises" class="nav-link">
                            <i class="fas fa-dumbbell"></i>
                            <span>Exercises</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="/workouts" class="nav-link">
                            <i class="fas fa-history"></i>
                            <span>Workouts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/templates" class="nav-link">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Templates</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/stats/weekly" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Statistics</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">ACCOUNT</h3>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/settings" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <form th:action="@{/logout}" method="post" style="display:inline;">
                            <button type="submit" class="nav-link" style="background:none; border:none; width:100%; text-align:left;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        </form>
                    </li>
                </ul>
            </div>
        </nav>
    </aside>

    
    <main class="main-content">
        
        <header class="top-header">
            <div class="header-left">
                <!-- Mobile only: User profile above title -->
                <div class="user-profile mobile-profile">
                    <div class="profile-avatar avatar-preview">
                        <img th:if="${navAvatar}" th:src="${navAvatar}" alt="Profile Picture" class="avatar-image">
                        <div class="avatar-placeholder" th:unless="${navAvatar}" style="display:flex;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <span class="profile-name" th:text="${username}">User</span>
                    </div>
                </div>
                <h1 class="page-title">Workout Details</h1>
            </div>
            <div class="header-right">
                <!-- Desktop only: User profile in top right (original) -->
                <div class="user-profile desktop-profile">
                    <div class="profile-avatar avatar-preview">
                        <img th:if="${navAvatar}" th:src="${navAvatar}" alt="Profile Picture" class="avatar-image">
                        <div class="avatar-placeholder" th:unless="${navAvatar}" style="display:flex;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <span class="profile-name" th:text="${username}">User</span>
                    </div>
                </div>
                <!-- Mobile only: Settings and Home Page buttons -->
                <div class="header-actions">
                    <a href="/settings" class="header-btn">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                    <a href="/" class="header-btn">
                        <i class="fas fa-home"></i>
                        <span>Home Page</span>
                    </a>
                </div>
            </div>
        </header>

        
        <div class="dashboard-content">
            
            <div class="page-header">
                <div class="page-title-section">
                    <div class="header-actions-container">
                        <a href="/workouts" class="back-link">
                            <i class="fas fa-arrow-left"></i>
                            Back to Workouts
                        </a>
                    </div>
                    <h1 class="page-title">
                        <i class="fas fa-chart-bar"></i>
                        <span class="details-mobile-title-text">Workout Details</span>
                    </h1>
                    <p class="page-subtitle">View your completed workout session</p>
                </div>
            </div>

            
            <div class="workout-summary-scroll"><div class="workout-summary">
                <div class="summary-card">
                    <div class="summary-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="summary-content">
                        <h3>Date</h3>
                        <p th:text="${#temporals.format(workout.startedAt, 'EEEE, MMMM dd, yyyy')}">Date</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="summary-content">
                        <h3>Duration</h3>
                        <p th:text="${#temporals.format(workout.startedAt, 'HH:mm')} + ' - ' + ${#temporals.format(workout.finishedAt, 'HH:mm')}">Time</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon">
                        <i class="fas fa-dumbbell"></i>
                    </div>
                    <div class="summary-content">
                        <h3>Exercises</h3>
                        <p th:text="${#lists.size(workout.exercises)} + ' exercises'">Exercises</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="summary-content">
                        <h3>Total Sets</h3>
                        <p th:text="${totalSets} + ' sets'">Total Sets</p>
                    </div>
                </div>
            </div></div>

            <!-- Edit Workout Button -->
            <div style="margin: 1.5rem 0; display: flex; justify-content: center;">
                <a th:href="@{|/workouts/session?sessionId=${sessionId}&edit=true|}" class="btn btn-primary" style="width: 100%; max-width: 500px; padding: 0.75rem 1.5rem; font-size: 1.1rem; text-align: center;">
                    <i class="fas fa-edit"></i>
                    Edit Workout
                </a>
            </div>

            
            <div class="workout-exercises">
                <h2 class="section-title">
                    <i class="fas fa-list"></i>
                    Exercises Performed
                </h2>

                <div class="exercises-details" id="exercisesDetails" th:if="${not #lists.isEmpty(workout.exercises)}" th:attr="data-unit-system=${unitSystem}">
                    
                    <div class="exercise-detail-card" th:each="exercise : ${workout.exercises}" 
                         th:attr="data-exercise-id=${exercise.exercise.id},
                                  data-exercise-name=${exercise.exercise.name},
                                  data-exercise-muscle=${exercise.exercise.primaryMuscle}">
                        <div class="sets-data" style="display: none;">
                            <div class="set-data" th:each="set : ${exercise.sets}"
                                 th:attr="data-weight=${set.weight},
                                          data-reps=${set.reps},
                                          data-group-id=${set.groupId},
                                          data-group-type=${set.groupType},
                                          data-group-order=${set.groupOrder},
                                          data-set-number=${set.setNumber}">
                            </div>
                        </div>
                    </div>
                </div>

                
                <div class="empty-state" th:if="${#lists.isEmpty(workout.exercises)}">
                    <div class="empty-icon">
                        <i class="fas fa-dumbbell"></i>
                    </div>
                    <h3>No exercises recorded</h3>
                    <p>This workout session doesn't have any recorded exercises.</p>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Unit system flag from DOM
        const unitContainer = document.getElementById('exercisesDetails');
        const isImperial = unitContainer && unitContainer.dataset.unitSystem === 'imperial';
        processExerciseGrouping();
        
        // Animate cards on load
        setTimeout(() => {
            const cards = document.querySelectorAll('.exercise-detail-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100 + (index * 100));
            });
        }, 50);

        // Animate summary cards
        const summaryCards = document.querySelectorAll('.summary-card');
        summaryCards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';

            setTimeout(() => {
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 50 + (index * 50));
        });
    });
    
    function processExerciseGrouping() {
        const container = document.getElementById('exercisesDetails');
        if (!container) return;
        
        const exerciseCards = Array.from(container.querySelectorAll('.exercise-detail-card'));
        const processedExercises = [];
        const supersetGroups = new Map(); // groupId -> exercises array
        
        // Extract all exercise data from the DOM
        const allExercises = exerciseCards.map(card => {
            const exerciseId = card.getAttribute('data-exercise-id');
            const exerciseName = card.getAttribute('data-exercise-name');
            const exerciseMuscle = card.getAttribute('data-exercise-muscle');
            
            const sets = [];
            const setElements = card.querySelectorAll('.set-data');
            setElements.forEach(setEl => {
                sets.push({
                    weight: parseFloat(setEl.getAttribute('data-weight')),
                    reps: parseInt(setEl.getAttribute('data-reps')),
                    groupId: setEl.getAttribute('data-group-id') || null,
                    groupType: setEl.getAttribute('data-group-type') || null,
                    groupOrder: setEl.getAttribute('data-group-order') ? parseInt(setEl.getAttribute('data-group-order')) : null,
                    setNumber: setEl.getAttribute('data-set-number') ? parseInt(setEl.getAttribute('data-set-number')) : null
                });
            });
            
            return { exerciseId, exerciseName, exerciseMuscle, sets };
        });
        
        // Group superset exercises by groupId
        allExercises.forEach(exercise => {
            const supersetSet = exercise.sets.find(s => s.groupType === 'SUPERSET' && s.groupId && s.groupId !== 'null');
            if (supersetSet) {
                const groupId = supersetSet.groupId;
                if (!supersetGroups.has(groupId)) {
                    supersetGroups.set(groupId, []);
                }
                supersetGroups.get(groupId).push(exercise);
            }
        });
        
        // Track which exercises are part of supersets
        const supersetExerciseIds = new Set();
        supersetGroups.forEach(group => {
            group.forEach(ex => supersetExerciseIds.add(ex.exerciseId));
        });
        
        // Build final ordered list
        const processedSupersetGroups = new Set();
        
        allExercises.forEach(exercise => {
            // Check if this exercise is part of a superset
            const supersetSet = exercise.sets.find(s => s.groupType === 'SUPERSET' && s.groupId && s.groupId !== 'null');
            
            if (supersetSet) {
                const groupId = supersetSet.groupId;
                
                // Only add the superset once (when we encounter the first exercise of the pair)
                if (!processedSupersetGroups.has(groupId)) {
                    const group = supersetGroups.get(groupId);
                    if (group && group.length === 2) {
                        // Sort by groupOrder to ensure correct pairing
                        group.sort((a, b) => {
                            const orderA = a.sets.find(s => s.groupType === 'SUPERSET')?.groupOrder || 0;
                            const orderB = b.sets.find(s => s.groupType === 'SUPERSET')?.groupOrder || 0;
                            return orderA - orderB;
                        });
                        
                        processedExercises.push({
                            type: 'superset',
                            groupId,
                            exercises: group
                        });
                        processedSupersetGroups.add(groupId);
                    }
                }
            } else {
                // Regular exercise (not part of any superset)
                processedExercises.push({
                    type: 'regular',
                    exerciseId: exercise.exerciseId,
                    exerciseName: exercise.exerciseName,
                    exerciseMuscle: exercise.exerciseMuscle,
                    sets: exercise.sets
                });
            }
        });
        
        // Clear and rebuild the container
        container.innerHTML = '';
        
        processedExercises.forEach(item => {
            if (item.type === 'superset') {
                container.appendChild(createSupersetCard(item));
            } else {
                container.appendChild(createRegularCard(item));
            }
        });
    }
    
    function createSupersetCard(data) {
        const card = document.createElement('div');
        card.className = 'exercise-detail-card superset-detail-card';
        
        const ex1 = data.exercises[0];
        const ex2 = data.exercises[1];
        
        // Filter superset sets only
        const supersetSets = ex1.sets.filter(s => s.groupType === 'SUPERSET');
        const totalVolume = supersetSets.reduce((sum, s, i) => {
            const ex2Set = ex2.sets.filter(s => s.groupType === 'SUPERSET')[i];
            return sum + (s.weight * s.reps) + (ex2Set ? ex2Set.weight * ex2Set.reps : 0);
        }, 0);
        const totalReps = supersetSets.reduce((sum, s, i) => {
            const ex2Set = ex2.sets.filter(s => s.groupType === 'SUPERSET')[i];
            return sum + (parseInt(s.reps || 0, 10)) + (ex2Set ? parseInt(ex2Set.reps || 0, 10) : 0);
        }, 0);
        
        let setsHTML = '';
        supersetSets.forEach((set1, index) => {
            const unitContainer = document.getElementById('exercisesDetails');
            const isImperial = unitContainer && unitContainer.dataset.unitSystem === 'imperial';
            const set1Display = isImperial ? (set1.weight * 2.20462).toFixed(1) + ' lb' : set1.weight + ' kg';
            const set2 = ex2.sets.filter(s => s.groupType === 'SUPERSET')[index];
            const set2Display = isImperial ? (set2.weight * 2.20462).toFixed(1) + ' lb' : set2.weight + ' kg';
            setsHTML += `
                <div class="superset-set-row">
                    <span class="set-number">${index + 1}</span>
                    <div class="superset-set-details">
                        <div class="exercise-set-detail">
                            <span class="exercise-label">${ex1.exerciseName}</span>
                            <span class="set-value">${set1Display} × ${set1.reps} reps</span>
                        </div>
                        <div class="superset-divider">+</div>
                        <div class="exercise-set-detail">
                            <span class="exercise-label">${ex2.exerciseName}</span>
                            <span class="set-value">${set2Display} × ${set2.reps} reps</span>
                        </div>
                    </div>
                    <span class="volume">${formatWeight(set1.weight * set1.reps + set2.weight * set2.reps)}</span>
                </div>
            `;
        });
        
        card.innerHTML = `
            <div class="exercise-header">
                <div class="exercise-info">
                    <h3 class="exercise-name">
                        <span class="superset-badge">SUPERSET</span>
                        <span class="superset-exercise-titles-desktop">${ex1.exerciseName} + ${ex2.exerciseName}</span>
                    </h3>
                    <div class="superset-exercise-titles-mobile">
                        ${ex1.exerciseName} + ${ex2.exerciseName}
                    </div>
                    <span class="exercise-muscle">${ex1.exerciseMuscle} / ${ex2.exerciseMuscle}</span>
                </div>
                <div class="exercise-stats">
                    <span class="stat-badge">
                        <i class="fas fa-layer-group"></i>
                        <span>${supersetSets.length} sets</span>
                    </span>
                </div>
            </div>
            <div class="sets-details">
                <div class="sets-table superset-table">
                    <div class="table-header">
                        <span>Set</span>
                        <span>Exercises</span>
                        <span>Volume</span>
                    </div>
                    <div class="table-body">
                        ${setsHTML}
                    </div>
                </div>
                <div class="exercise-summary">
                    <div class="summary-stat">
                        <span class="stat-label">Total Volume:</span>
                        <span class="stat-value">${formatWeight(totalVolume)}</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Sets Completed:</span>
                        <span class="stat-value">${supersetSets.length} sets</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Total Reps:</span>
                        <span class="stat-value">${totalReps} reps</span>
                    </div>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // Helper function to format weight/volume with tons
    function formatWeight(weightKg) {
        const unitContainer = document.getElementById('exercisesDetails');
        const isImperial = unitContainer && unitContainer.dataset.unitSystem === 'imperial';
        if (isImperial) {
            const weightLb = weightKg * 2.20462;
            return weightLb.toFixed(1) + ' lb';
        }
        if (weightKg >= 1000) {
            const tons = weightKg / 1000;
            return tons.toFixed(2) + ' Ton' + (tons !== 1 ? 's' : '');
        }
        return weightKg.toFixed(1) + ' kg';
    }

    function createRegularCard(data) {
        const card = document.createElement('div');
        card.className = 'exercise-detail-card';
        
        
        const totalVolume = data.sets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
        const totalReps = data.sets.reduce((sum, s) => sum + s.reps, 0);
        const avgWeightKg = totalReps > 0 ? (totalVolume / totalReps) : 0;
        const unitContainer = document.getElementById('exercisesDetails');
        const isImperial = unitContainer && unitContainer.dataset.unitSystem === 'imperial';
        
        // Count actual sets (not including drop sets as separate sets)
        const regularSetCount = data.sets.filter(s => !s.groupType || s.groupType !== 'DROP_SET' || (s.groupOrder === 0 || s.groupOrder === '0')).length;
        
        let setsHTML = '';
        let setNumber = 1;
        
        
        
        // Group sets by setNumber for proper drop set display
        const setsBySetNumber = new Map();
        data.sets.forEach(set => {
            const setNum = set.setNumber || setNumber; // fallback to current set number
            if (!setsBySetNumber.has(setNum)) {
                setsBySetNumber.set(setNum, []);
            }
            setsBySetNumber.get(setNum).push(set);
        });
        
        // Process sets in order by setNumber
        const sortedSetNumbers = Array.from(setsBySetNumber.keys()).sort((a, b) => a - b);
        
        for (const setNum of sortedSetNumbers) {
            const setsForThisNumber = setsBySetNumber.get(setNum);
            
            
            // Find the main set (groupOrder 0 or no group)
            const mainSet = setsForThisNumber.find(s => !s.groupType || s.groupType !== 'DROP_SET' || s.groupOrder === 0);
            const dropSets = setsForThisNumber.filter(s => s.groupType === 'DROP_SET' && s.groupOrder > 0);
            
            if (mainSet) {
                // Render main set
                const displayMainWeight = isImperial ? (mainSet.weight * 2.20462).toFixed(1) + ' lb' : mainSet.weight + ' kg';
                setsHTML += `
                    <div class="set-row">
                        <span class="set-number">${setNum}</span>
                        <span class="weight">${displayMainWeight}</span>
                        <span class="reps">${mainSet.reps} reps</span>
                        <span class="volume">${formatWeight(mainSet.weight * mainSet.reps)}</span>
                    </div>
                `;
                
                
                // Render drop sets for this main set
                dropSets.forEach(dropSet => {
                    const displayDropWeight = isImperial ? (dropSet.weight * 2.20462).toFixed(1) + ' lb' : dropSet.weight + ' kg';
                    
                    setsHTML += `
                        <div class="set-row drop-set-row">
                            <span class="set-number">
                                <span class="drop-badge">Drop ${dropSet.groupOrder}</span>
                            </span>
                            <span class="weight">${displayDropWeight}</span>
                            <span class="reps">${dropSet.reps} reps</span>
                            <span class="volume">${formatWeight(dropSet.weight * dropSet.reps)}</span>
                        </div>
                    `;
                    
                });
            } else {
                // No main set found, treat all as regular sets
                setsForThisNumber.forEach(set => {
                    const displaySetWeight = isImperial ? (set.weight * 2.20462).toFixed(1) + ' lb' : set.weight + ' kg';
                    setsHTML += `
                        <div class="set-row">
                            <span class="set-number">${setNum}</span>
                            <span class="weight">${displaySetWeight}</span>
                            <span class="reps">${set.reps} reps</span>
                            <span class="volume">${formatWeight(set.weight * set.reps)}</span>
                        </div>
                    `;
                });
            }
        }
        
        card.innerHTML = `
            <div class="exercise-header">
                <div class="exercise-info">
                    <h3 class="exercise-name">${data.exerciseName}</h3>
                    <span class="exercise-muscle">${data.exerciseMuscle}</span>
                </div>
                <div class="exercise-stats">
                    <span class="stat-badge">
                        <i class="fas fa-layer-group"></i>
                        <span>${regularSetCount} sets</span>
                    </span>
                </div>
            </div>
            <div class="sets-details">
                <div class="sets-table">
                    <div class="table-header">
                        <span>Set</span>
                        <span>Weight</span>
                        <span>Reps</span>
                        <span>Volume</span>
                    </div>
                    <div class="table-body">
                        ${setsHTML}
                    </div>
                </div>
                <div class="exercise-summary">
                    <div class="summary-stat">
                        <span class="stat-label">Total Volume:</span>
                        <span class="stat-value">${formatWeight(totalVolume)}</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Average Weight:</span>
                        <span class="stat-value">${isImperial ? (avgWeightKg * 2.20462).toFixed(1) + ' lb' : avgWeightKg.toFixed(1) + ' kg'}</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Total Reps:</span>
                        <span class="stat-value">${totalReps} reps</span>
                    </div>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // Prevent overscrolling by clamping scroll position
    function clampScrollPosition() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = Math.max(
            document.body.scrollHeight,
            document.body.offsetHeight,
            document.documentElement.clientHeight,
            document.documentElement.scrollHeight,
            document.documentElement.offsetHeight
        );
        const clientHeight = window.innerHeight || document.documentElement.clientHeight;
        const maxScroll = Math.max(0, scrollHeight - clientHeight);
        
        if (scrollTop < 0) {
            window.scrollTo(0, 0);
        } else if (scrollTop > maxScroll) {
            window.scrollTo(0, maxScroll);
        }
    }
    
    let scrollTimeout;
    function handleScroll() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(clampScrollPosition, 10);
    }
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('touchmove', handleScroll, { passive: true });
    window.addEventListener('wheel', handleScroll, { passive: true });
    
    document.addEventListener('DOMContentLoaded', function() {
        clampScrollPosition();
        window.addEventListener('resize', function() {
            setTimeout(clampScrollPosition, 100);
        });
    });
</script>
</body>
</html>
