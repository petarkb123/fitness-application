<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Height & Weight - FitPower</title>
    <link rel="stylesheet" th:href="@{/css/desktop/onboarding.css}">
    <link rel="stylesheet" th:href="@{/css/mobile/onboarding-mobile.css}" media="(max-width: 480px)">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
<div class="background-elements">
    <div class="bg-circle bg-circle-1"></div>
    <div class="bg-circle bg-circle-2"></div>
</div>

<div class="main-glass-container">
    <div class="onboarding-container">
        <!-- Progress Bar -->
        <div class="progress-container">
            <a href="/onboarding/workout-frequency-direct" class="back-arrow">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 24%"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="onboarding-content">
            <h1 class="onboarding-title">Height & weight</h1>
            <p class="onboarding-subtitle">This will be used to calibrate your custom plan.</p>

            <form th:action="@{/onboarding/height-weight}" method="post" class="onboarding-form" id="heightWeightForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="unitSystem" id="unitSystem" th:value="${selectedUnitSystem != null ? selectedUnitSystem : 'metric'}">
                
                <!-- Unit Toggle -->
                <div class="unit-toggle-container">
                    <label class="unit-label" id="imperialLabel" th:classappend="${selectedUnitSystem == 'imperial'} ? 'active' : ''">Imperial</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="unitToggle" th:checked="${selectedUnitSystem == 'imperial'}">
                        <span class="toggle-slider"></span>
                    </label>
                    <label class="unit-label" id="metricLabel" th:classappend="${selectedUnitSystem != 'imperial'} ? 'active' : ''">Metric</label>
                </div>

                <!-- Metric Input (Default) -->
                <div id="metricInputs" class="input-section" th:style="${selectedUnitSystem == 'imperial'} ? 'display: none;' : ''">
                    <div class="input-row">
                        <div class="input-column">
                            <label class="input-label">Height</label>
                            <div class="picker-container">
                                <select name="cm" id="heightCm" class="picker-select" required>
                                    <option value="">cm</option>
                                    <option th:each="h : ${#numbers.sequence(120, 220)}" th:value="${h}" th:text="${h + ' cm'}" th:selected="${heightCm != null && h == heightCm}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="input-column">
                            <label class="input-label">Weight</label>
                            <div class="picker-container">
                                <select name="kg" id="weightKg" class="picker-select" required>
                                    <option value="">kg</option>
                                    <option th:each="w : ${#numbers.sequence(30, 150)}" th:value="${w}" th:text="${w + ' kg'}" th:selected="${weightKg != null && w == weightKg}"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Imperial Input (Hidden) -->
                <div id="imperialInputs" class="input-section" th:style="${selectedUnitSystem == 'imperial'} ? '' : 'display: none;'">
                    <div class="input-row">
                        <div class="input-column">
                            <label class="input-label">Height</label>
                            <div class="picker-row-inner">
                                <div class="picker-container">
                                    <select name="feet" id="heightFeet" class="picker-select">
                                        <option value="">ft</option>
                                        <option th:each="f : ${#numbers.sequence(4, 7)}" th:value="${f}" th:text="${f + ' ft'}" th:selected="${heightFeet != null && f == heightFeet}"></option>
                                    </select>
                                </div>
                                <div class="picker-container">
                                    <select name="inches" id="heightInches" class="picker-select">
                                        <option value="">in</option>
                                        <option th:each="i : ${#numbers.sequence(0, 11)}" th:value="${i}" th:text="${i + ' in'}" th:selected="${heightInches != null && i == heightInches}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="input-column">
                            <label class="input-label">Weight</label>
                            <div class="picker-container">
                                    <select name="lbs" id="weightLbs" class="picker-select">
                                    <option value="">lb</option>
                                        <option th:each="w : ${#numbers.sequence(66, 330)}" th:value="${w}" th:text="${w + ' lb'}" th:selected="${weightLbs != null && w == weightLbs}"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-large">
                    Continue
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Prevent overscrolling by clamping scroll position
    function clampScrollPosition() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = Math.max(
            document.body.scrollHeight,
            document.body.offsetHeight,
            document.documentElement.clientHeight,
            document.documentElement.scrollHeight,
            document.documentElement.offsetHeight
        );
        const clientHeight = window.innerHeight || document.documentElement.clientHeight;
        const maxScroll = Math.max(0, scrollHeight - clientHeight);
        
        if (scrollTop < 0) {
            window.scrollTo(0, 0);
        } else if (scrollTop > maxScroll) {
            window.scrollTo(0, maxScroll);
        }
    }
    
    let scrollTimeout;
    function handleScroll() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(clampScrollPosition, 10);
    }
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('touchmove', handleScroll, { passive: true });
    window.addEventListener('wheel', handleScroll, { passive: true });
    
    document.addEventListener('DOMContentLoaded', function() {
        clampScrollPosition();
        window.addEventListener('resize', function() {
            setTimeout(clampScrollPosition, 100);
        });
        const unitToggle = document.getElementById('unitToggle');
        const unitSystemInput = document.getElementById('unitSystem');
        const metricInputs = document.getElementById('metricInputs');
        const imperialInputs = document.getElementById('imperialInputs');
        const cmSelect = document.getElementById('heightCm');
        const kgSelect = document.getElementById('weightKg');
        const feetSelect = document.getElementById('heightFeet');
        const inchesSelect = document.getElementById('heightInches');
        const lbsSelect = document.getElementById('weightLbs');

        function applyRequiredState(isImperial) {
            // Toggle required attributes
            cmSelect.required = !isImperial;
            kgSelect.required = !isImperial;
            feetSelect.required = isImperial;
            inchesSelect.required = isImperial;
            lbsSelect.required = isImperial;
            // Disable hidden fields to avoid HTML5 validation of hidden required controls
            cmSelect.disabled = isImperial;
            kgSelect.disabled = isImperial;
            feetSelect.disabled = !isImperial;
            inchesSelect.disabled = !isImperial;
            lbsSelect.disabled = !isImperial;
        }

        // Initialize based on saved unit system
        const savedUnitSystem = unitSystemInput.value;
        if (savedUnitSystem === 'imperial') {
            unitToggle.checked = true;
            metricInputs.style.display = 'none';
            imperialInputs.style.display = 'block';
            document.getElementById('imperialLabel').classList.add('active');
            document.getElementById('metricLabel').classList.remove('active');
            applyRequiredState(true);
        } else {
            unitToggle.checked = false;
            imperialInputs.style.display = 'none';
            metricInputs.style.display = 'block';
            document.getElementById('metricLabel').classList.add('active');
            document.getElementById('imperialLabel').classList.remove('active');
            applyRequiredState(false);
        }

        unitToggle.addEventListener('change', function() {
            if (this.checked) {
                unitSystemInput.value = 'imperial';
                metricInputs.style.display = 'none';
                imperialInputs.style.display = 'block';
                document.getElementById('imperialLabel').classList.add('active');
                document.getElementById('metricLabel').classList.remove('active');
                applyRequiredState(true);
            } else {
                unitSystemInput.value = 'metric';
                imperialInputs.style.display = 'none';
                metricInputs.style.display = 'block';
                document.getElementById('metricLabel').classList.add('active');
                document.getElementById('imperialLabel').classList.remove('active');
                applyRequiredState(false);
            }
        });

        // Form validation
        document.getElementById('heightWeightForm').addEventListener('submit', function(e) {
            const isImperial = unitSystemInput.value === 'imperial';
            if (isImperial) {
                const feet = document.getElementById('heightFeet').value;
                const inches = document.getElementById('heightInches').value;
                const lbs = document.getElementById('weightLbs').value;
                if (!feet || !inches || !lbs) {
                    e.preventDefault();
                    alert('Please select all values');
                    return;
                }
                // Validate ranges: height 120–220 cm, weight 66–330 lb (~30–150 kg)
                const totalCm = (parseInt(feet, 10) * 30.48) + (parseInt(inches, 10) * 2.54);
                const weightLb = parseInt(lbs, 10);
                if (totalCm < 120 || totalCm > 220) {
                    e.preventDefault();
                    alert('Please choose a height between 4 ft (121 cm) and ~7 ft 3 in (220 cm).');
                    return;
                }
                if (weightLb < 66 || weightLb > 330) {
                    e.preventDefault();
                    alert('Please choose a weight between 66 lb (30 kg) and 330 lb (150 kg).');
                    return;
                }
            } else {
                const cm = document.getElementById('heightCm').value;
                const kg = document.getElementById('weightKg').value;
                if (!cm || !kg) {
                    e.preventDefault();
                    alert('Please select all values');
                    return;
                }
                // Validate ranges: height 120–220 cm, weight 30–150 kg
                const heightCm = parseInt(cm, 10);
                const weightKg = parseInt(kg, 10);
                if (heightCm < 120 || heightCm > 220) {
                    e.preventDefault();
                    alert('Please choose a height between 120 cm and 220 cm.');
                    return;
                }
                if (weightKg < 30 || weightKg > 150) {
                    e.preventDefault();
                    alert('Please choose a weight between 30 kg and 150 kg.');
                    return;
                }
            }
        });
    });
</script>
</body>
</html>
