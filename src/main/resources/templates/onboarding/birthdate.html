<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Birthdate - FitPower</title>
    <link rel="stylesheet" th:href="@{/css/desktop/onboarding.css}">
    <link rel="stylesheet" th:href="@{/css/mobile/onboarding-mobile.css}" media="(max-width: 480px)">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
<div class="background-elements">
    <div class="bg-circle bg-circle-1"></div>
    <div class="bg-circle bg-circle-2"></div>
</div>

<div class="main-glass-container">
    <div class="onboarding-container">
        <!-- Progress Bar -->
        <div class="progress-container">
            <a href="/onboarding/height-weight-direct" class="back-arrow">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 32%"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="onboarding-content">
            <h1 class="onboarding-title">When were you born?</h1>
            <p class="onboarding-subtitle">This will be used to calibrate your custom plan.</p>

            <form th:action="@{/onboarding/birthdate}" method="post" class="onboarding-form" id="birthdateForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="timezone" id="timezoneInput" />
                
                <div class="date-picker-container">
                    <div class="date-picker-column">
                        <label class="date-label">Month</label>
                        <select name="month" id="birthMonth" class="date-picker" required>
                            <option value="">--</option>
                            <option value="01" th:selected="${birthdate != null && birthdate.contains('-01-')}">January</option>
                            <option value="02" th:selected="${birthdate != null && birthdate.contains('-02-')}">February</option>
                            <option value="03" th:selected="${birthdate != null && birthdate.contains('-03-')}">March</option>
                            <option value="04" th:selected="${birthdate != null && birthdate.contains('-04-')}">April</option>
                            <option value="05" th:selected="${birthdate != null && birthdate.contains('-05-')}">May</option>
                            <option value="06" th:selected="${birthdate != null && birthdate.contains('-06-')}">June</option>
                            <option value="07" th:selected="${birthdate != null && birthdate.contains('-07-')}">July</option>
                            <option value="08" th:selected="${birthdate != null && birthdate.contains('-08-')}">August</option>
                            <option value="09" th:selected="${birthdate != null && birthdate.contains('-09-')}">September</option>
                            <option value="10" th:selected="${birthdate != null && birthdate.contains('-10-')}">October</option>
                            <option value="11" th:selected="${birthdate != null && birthdate.contains('-11-')}">November</option>
                            <option value="12" th:selected="${birthdate != null && birthdate.contains('-12-')}">December</option>
                        </select>
                    </div>
                    
                    <div class="date-picker-column">
                        <label class="date-label">Day</label>
                        <select name="day" id="birthDay" class="date-picker" required>
                            <option value="">--</option>
                            <option th:each="d : ${#numbers.sequence(1, 31)}" 
                                    th:value="${d < 10} ? '0' + ${d} : ${d}" 
                                    th:text="${d}"
                                    th:selected="${birthdate != null && birthdate.endsWith('-' + (d < 10 ? '0' + d : d))}"></option>
                        </select>
                    </div>
                    
                    <div class="date-picker-column">
                        <label class="date-label">Year</label>
                        <select name="year" id="birthYear" class="date-picker" required>
                            <option value="">--</option>
                            <option th:each="y : ${#numbers.sequence(1975, 2015)}" 
                                    th:value="${y}" 
                                    th:text="${y}"
                                    th:selected="${birthdate != null && birthdate.startsWith(y + '-')}"></option>
                        </select>
                    </div>
                </div>

                <!-- Timezone Selector -->
                <div class="timezone-selector">
                    <label class="timezone-label">Timezone</label>
                    <button type="button" id="timezoneBtn" class="timezone-btn" required>
                        <span id="timezoneDisplay">Select your timezone</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <input type="hidden" name="timezone" id="timezoneInput" th:value="${timezone}" required>
                </div>

                <button type="submit" class="btn btn-primary btn-large">
                    Continue
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Timezone Modal -->
<div id="timezoneModal" class="timezone-modal" style="display: none;">
    <div class="timezone-modal-content">
        <div class="timezone-modal-header">
            <h3>Select your timezone</h3>
            <button type="button" class="timezone-modal-close" id="closeTimezoneModal">&times;</button>
        </div>
        <div class="timezone-modal-body">
            <input type="text" id="timezoneSearch" class="timezone-search" placeholder="Search timezone (e.g., Madrid, New York, Tokyo)">
            <div id="timezoneList" class="timezone-list"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('birthdateForm');
        const monthSelect = document.getElementById('birthMonth');
        const daySelect = document.getElementById('birthDay');
        const yearSelect = document.getElementById('birthYear');

        // Parse saved birthdate if exists
        const savedBirthdate = /*[[${birthdate}]]*/ null;
        console.log('Saved birthdate from server:', savedBirthdate);
        
        // Only run JavaScript restoration if Thymeleaf hasn't already set the values
        if (savedBirthdate && (!monthSelect.value || !yearSelect.value || !daySelect.value)) {
            const parts = savedBirthdate.split('-');
            console.log('Birthdate parts:', parts);
            if (parts.length === 3) {
                const year = parts[0];
                const month = parts[1];
                const day = parts[2];
                console.log('Setting values - year:', year, 'month:', month, 'day:', day);
                
                // Set the values
                monthSelect.value = month;
                yearSelect.value = year;
                
                // Update day options and set day
                updateDayOptions();
                // Use setTimeout to ensure day options are populated
                setTimeout(() => {
                    daySelect.value = day;
                    console.log('Day set to:', daySelect.value);
                }, 50);
            }
        } else if (savedBirthdate) {
            console.log('Thymeleaf already set the values, skipping JavaScript restoration');
        }

        function updateDayOptions() {
            const month = parseInt(monthSelect.value);
            const year = parseInt(yearSelect.value);
            const currentDay = parseInt(daySelect.value);
            
            // Only update if both month and year are selected
            if (month && year) {
                const daysInMonth = new Date(year, month, 0).getDate();
                const optionCount = daySelect.options.length - 1; // Exclude "--"
                
                // Only update if the number of days changed
                if (optionCount !== daysInMonth) {
                    daySelect.innerHTML = '<option value="">--</option>';
                    for (let i = 1; i <= daysInMonth; i++) {
                        const option = document.createElement('option');
                        option.value = i < 10 ? '0' + i : i;
                        option.textContent = i;
                        if (currentDay && i === currentDay) option.selected = true;
                        daySelect.appendChild(option);
                    }
                }
            } else if (month && !year) {
                // If only month is selected, show all 31 days
                const optionCount = daySelect.options.length - 1;
                
                if (optionCount !== 31) {
                    daySelect.innerHTML = '<option value="">--</option>';
                    for (let i = 1; i <= 31; i++) {
                        const option = document.createElement('option');
                        option.value = i < 10 ? '0' + i : i;
                        option.textContent = i;
                        if (currentDay && i === currentDay) option.selected = true;
                        daySelect.appendChild(option);
                    }
                }
            } else if (!month && !year) {
                // If neither month nor year is selected, show all 31 days
                const optionCount = daySelect.options.length - 1;
                
                if (optionCount !== 31) {
                    daySelect.innerHTML = '<option value="">--</option>';
                    for (let i = 1; i <= 31; i++) {
                        const option = document.createElement('option');
                        option.value = i < 10 ? '0' + i : i;
                        option.textContent = i;
                        if (currentDay && i === currentDay) option.selected = true;
                        daySelect.appendChild(option);
                    }
                }
            }
        }

        // Initialize day options on page load
        updateDayOptions();
        
        monthSelect.addEventListener('change', updateDayOptions);
        yearSelect.addEventListener('change', updateDayOptions);

        form.addEventListener('submit', function(e) {
            const month = monthSelect.value;
            const day = daySelect.value;
            const year = yearSelect.value;

            if (!month || !day || !year) {
                e.preventDefault();
                alert('Please select a complete date');
                return;
            }

            // Form will submit the individual fields directly
        });
    });
    
    // Prevent overscrolling by clamping scroll position
    function clampScrollPosition() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = Math.max(
            document.body.scrollHeight,
            document.body.offsetHeight,
            document.documentElement.clientHeight,
            document.documentElement.scrollHeight,
            document.documentElement.offsetHeight
        );
        const clientHeight = window.innerHeight || document.documentElement.clientHeight;
        const maxScroll = Math.max(0, scrollHeight - clientHeight);
        
        if (scrollTop < 0) {
            window.scrollTo(0, 0);
        } else if (scrollTop > maxScroll) {
            window.scrollTo(0, maxScroll);
        }
    }
    
    let scrollTimeout;
    function handleScroll() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(clampScrollPosition, 10);
    }
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('touchmove', handleScroll, { passive: true });
    window.addEventListener('wheel', handleScroll, { passive: true });
    
    document.addEventListener('DOMContentLoaded', function() {
        clampScrollPosition();
        window.addEventListener('resize', function() {
            setTimeout(clampScrollPosition, 100);
        });
        
        // Timezone selector
        const timezoneBtn = document.getElementById('timezoneBtn');
        const timezoneInput = document.getElementById('timezoneInput');
        const timezoneDisplay = document.getElementById('timezoneDisplay');
        const timezoneModal = document.getElementById('timezoneModal');
        const closeTimezoneModal = document.getElementById('closeTimezoneModal');
        const timezoneSearch = document.getElementById('timezoneSearch');
        const timezoneList = document.getElementById('timezoneList');
        
        // Comprehensive IANA timezones
        const timezones = [
            // Europe
            {label: 'Europe/London (GMT/BST)', value: 'Europe/London'},
            {label: 'Europe/Dublin (GMT/IST)', value: 'Europe/Dublin'},
            {label: 'Europe/Lisbon (WET/WEST)', value: 'Europe/Lisbon'},
            {label: 'Europe/Paris (CET/CEST)', value: 'Europe/Paris'},
            {label: 'Europe/Madrid (CET/CEST)', value: 'Europe/Madrid'},
            {label: 'Europe/Berlin (CET/CEST)', value: 'Europe/Berlin'},
            {label: 'Europe/Rome (CET/CEST)', value: 'Europe/Rome'},
            {label: 'Europe/Amsterdam (CET/CEST)', value: 'Europe/Amsterdam'},
            {label: 'Europe/Brussels (CET/CEST)', value: 'Europe/Brussels'},
            {label: 'Europe/Vienna (CET/CEST)', value: 'Europe/Vienna'},
            {label: 'Europe/Prague (CET/CEST)', value: 'Europe/Prague'},
            {label: 'Europe/Warsaw (CET/CEST)', value: 'Europe/Warsaw'},
            {label: 'Europe/Stockholm (CET/CEST)', value: 'Europe/Stockholm'},
            {label: 'Europe/Copenhagen (CET/CEST)', value: 'Europe/Copenhagen'},
            {label: 'Europe/Oslo (CET/CEST)', value: 'Europe/Oslo'},
            {label: 'Europe/Helsinki (EET/EEST)', value: 'Europe/Helsinki'},
            {label: 'Europe/Athens (EET/EEST)', value: 'Europe/Athens'},
            {label: 'Europe/Sofia (EET/EEST)', value: 'Europe/Sofia'},
            {label: 'Europe/Bucharest (EET/EEST)', value: 'Europe/Bucharest'},
            {label: 'Europe/Budapest (CET/CEST)', value: 'Europe/Budapest'},
            {label: 'Europe/Istanbul (TRT)', value: 'Europe/Istanbul'},
            {label: 'Europe/Moscow (MSK)', value: 'Europe/Moscow'},
            {label: 'Europe/Kiev (EET/EEST)', value: 'Europe/Kiev'},
            // North America
            {label: 'America/New_York (EST/EDT)', value: 'America/New_York'},
            {label: 'America/Chicago (CST/CDT)', value: 'America/Chicago'},
            {label: 'America/Denver (MST/MDT)', value: 'America/Denver'},
            {label: 'America/Los_Angeles (PST/PDT)', value: 'America/Los_Angeles'},
            {label: 'America/Toronto (EST/EDT)', value: 'America/Toronto'},
            {label: 'America/Vancouver (PST/PDT)', value: 'America/Vancouver'},
            {label: 'America/Montreal (EST/EDT)', value: 'America/Montreal'},
            {label: 'America/Mexico_City (CST)', value: 'America/Mexico_City'},
            {label: 'America/Phoenix (MST)', value: 'America/Phoenix'},
            {label: 'America/Seattle (PST/PDT)', value: 'America/Seattle'},
            {label: 'America/Dallas (CST/CDT)', value: 'America/Dallas'},
            {label: 'America/Houston (CST/CDT)', value: 'America/Houston'},
            {label: 'America/Miami (EST/EDT)', value: 'America/Miami'},
            {label: 'America/Boston (EST/EDT)', value: 'America/Boston'},
            {label: 'America/Anchorage (AKST/AKDT)', value: 'America/Anchorage'},
            {label: 'Pacific/Honolulu (HST)', value: 'Pacific/Honolulu'},
            // Asia
            {label: 'Asia/Tokyo (JST)', value: 'Asia/Tokyo'},
            {label: 'Asia/Seoul (KST)', value: 'Asia/Seoul'},
            {label: 'Asia/Shanghai (CST)', value: 'Asia/Shanghai'},
            {label: 'Asia/Beijing (CST)', value: 'Asia/Beijing'},
            {label: 'Asia/Hong_Kong (HKT)', value: 'Asia/Hong_Kong'},
            {label: 'Asia/Taipei (CST)', value: 'Asia/Taipei'},
            {label: 'Asia/Singapore (SGT)', value: 'Asia/Singapore'},
            {label: 'Asia/Bangkok (ICT)', value: 'Asia/Bangkok'},
            {label: 'Asia/Jakarta (WIB)', value: 'Asia/Jakarta'},
            {label: 'Asia/Manila (PHT)', value: 'Asia/Manila'},
            {label: 'Asia/Kuala_Lumpur (MYT)', value: 'Asia/Kuala_Lumpur'},
            {label: 'Asia/Dubai (GST)', value: 'Asia/Dubai'},
            {label: 'Asia/Riyadh (AST)', value: 'Asia/Riyadh'},
            {label: 'Asia/Tehran (IRST)', value: 'Asia/Tehran'},
            {label: 'Asia/Kolkata (IST)', value: 'Asia/Kolkata'},
            {label: 'Asia/Mumbai (IST)', value: 'Asia/Mumbai'},
            {label: 'Asia/Delhi (IST)', value: 'Asia/Delhi'},
            {label: 'Asia/Karachi (PKT)', value: 'Asia/Karachi'},
            {label: 'Asia/Dhaka (BST)', value: 'Asia/Dhaka'},
            {label: 'Asia/Colombo (IST)', value: 'Asia/Colombo'},
            {label: 'Asia/Kathmandu (NPT)', value: 'Asia/Kathmandu'},
            {label: 'Asia/Jerusalem (IST/IDT)', value: 'Asia/Jerusalem'},
            // Oceania
            {label: 'Australia/Sydney (AEST/AEDT)', value: 'Australia/Sydney'},
            {label: 'Australia/Melbourne (AEST/AEDT)', value: 'Australia/Melbourne'},
            {label: 'Australia/Brisbane (AEST)', value: 'Australia/Brisbane'},
            {label: 'Australia/Perth (AWST)', value: 'Australia/Perth'},
            {label: 'Australia/Adelaide (ACST/ACDT)', value: 'Australia/Adelaide'},
            {label: 'Pacific/Auckland (NZST/NZDT)', value: 'Pacific/Auckland'},
            {label: 'Pacific/Fiji (FJT)', value: 'Pacific/Fiji'},
            // South America
            {label: 'America/Sao_Paulo (BRT)', value: 'America/Sao_Paulo'},
            {label: 'America/Buenos_Aires (ART)', value: 'America/Buenos_Aires'},
            {label: 'America/Lima (PET)', value: 'America/Lima'},
            {label: 'America/Bogota (COT)', value: 'America/Bogota'},
            {label: 'America/Santiago (CLT)', value: 'America/Santiago'},
            {label: 'America/Caracas (VET)', value: 'America/Caracas'},
            {label: 'America/Rio_de_Janeiro (BRT)', value: 'America/Rio_de_Janeiro'},
            // Africa
            {label: 'Africa/Johannesburg (SAST)', value: 'Africa/Johannesburg'},
            {label: 'Africa/Cairo (EET)', value: 'Africa/Cairo'},
            {label: 'Africa/Lagos (WAT)', value: 'Africa/Lagos'},
            {label: 'Africa/Nairobi (EAT)', value: 'Africa/Nairobi'},
            {label: 'Africa/Casablanca (WET)', value: 'Africa/Casablanca'},
            {label: 'Africa/Addis_Ababa (EAT)', value: 'Africa/Addis_Ababa'},
            {label: 'Africa/Dar_es_Salaam (EAT)', value: 'Africa/Dar_es_Salaam'},
            // UTC
            {label: 'UTC', value: 'UTC'}
        ];
        
        function renderTimezones(tzList) {
            timezoneList.innerHTML = '';
            tzList.forEach(tz => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'timezone-option-btn';
                btn.textContent = tz.label;
                btn.value = tz.value;
                btn.addEventListener('click', function() {
                    timezoneInput.value = tz.value;
                    timezoneDisplay.textContent = tz.label;
                    timezoneModal.style.display = 'none';
                });
                timezoneList.appendChild(btn);
            });
        }
        
        // Auto-detect and set timezone
        try {
            const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (detectedTimezone) {
                const tz = timezones.find(t => t.value === detectedTimezone);
                if (tz) {
                    timezoneInput.value = tz.value;
                    timezoneDisplay.textContent = tz.label;
                } else {
                    timezoneInput.value = detectedTimezone;
                    timezoneDisplay.textContent = detectedTimezone;
                }
            }
        } catch (e) {
            console.warn('Could not detect timezone:', e);
            timezoneInput.value = 'UTC';
            timezoneDisplay.textContent = 'UTC';
        }
        
        // Initialize timezone list
        renderTimezones(timezones);
        
        // Open modal
        timezoneBtn.addEventListener('click', function() {
            timezoneModal.style.display = 'flex';
            timezoneSearch.value = '';
            renderTimezones(timezones);
        });
        
        // Close modal
        closeTimezoneModal.addEventListener('click', function() {
            timezoneModal.style.display = 'none';
        });
        
        // Close on outside click
        timezoneModal.addEventListener('click', function(e) {
            if (e.target === timezoneModal) {
                timezoneModal.style.display = 'none';
            }
        });
        
        // Search filter
        timezoneSearch.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const filtered = timezones.filter(tz => 
                tz.label.toLowerCase().includes(query) || 
                tz.value.toLowerCase().includes(query)
            );
            renderTimezones(filtered);
        });
        
        // Form validation
        form.addEventListener('submit', function(e) {
            if (!timezoneInput.value) {
                e.preventDefault();
                alert('Please select your timezone');
                timezoneBtn.focus();
                return;
            }
        });
    });
</script>
</body>
</html>
