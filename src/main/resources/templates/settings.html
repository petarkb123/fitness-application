<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FitPower - Settings</title>
    <link rel="stylesheet" th:href="@{/css/desktop/settings.css}">
    <link rel="stylesheet" th:href="@{/css/mobile/settings-mobile.css}" media="(max-width: 480px)">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
<div class="dashboard-container">
    
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <i class="fas fa-dumbbell"></i>
                <span>FitPower</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">MAIN MENU</h3>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/dashboard" class="nav-link">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/exercises" class="nav-link">
                            <i class="fas fa-dumbbell"></i>
                            <span>Exercises</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/workouts" class="nav-link">
                            <i class="fas fa-history"></i>
                            <span>Workouts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/templates" class="nav-link">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Templates</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/stats/weekly" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Statistics</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">ACCOUNT</h3>
                <ul class="nav-list">
                    <li class="nav-item active">
                        <a href="/settings" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <form th:action="@{/logout}" method="post" style="display:inline;">
                            <button type="submit" class="nav-link" style="background:none; border:none; width:100%; text-align:left;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        </form>
                    </li>
                </ul>
            </div>
        </nav>
    </aside>

    
    <main class="main-content">
        
        <header class="top-header">
            <div class="header-left">
                <!-- Mobile only: User profile above title -->
                <div class="user-profile mobile-profile">
                    <div class="profile-avatar avatar-preview">
                        <img th:if="${navAvatar}" th:src="${navAvatar}" alt="Profile Picture" class="avatar-image">
                        <div class="avatar-placeholder" th:unless="${navAvatar}" style="display:flex;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <span class="profile-name" th:text="${username}">User</span>
                    </div>
                </div>
                <h1 class="page-title">Settings</h1>
            </div>
            <div class="header-right">
                <!-- Desktop only: User profile in top right (original) -->
                <div class="user-profile desktop-profile">
                    <div class="profile-avatar avatar-preview">
                        <img th:if="${navAvatar}" th:src="${navAvatar}" alt="Profile Picture" class="avatar-image">
                        <div class="avatar-placeholder" th:unless="${navAvatar}" style="display:flex;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <span class="profile-name" th:text="${username}">User</span>
                    </div>
                </div>
                <!-- Mobile only: Home Page button -->
                <div class="header-actions">
                    <a href="/" class="header-btn">
                        <i class="fas fa-home"></i>
                        <span>Home Page</span>
                    </a>
                </div>
            </div>
        </header>

        
        <div class="dashboard-content">
            
            <div class="page-header">
                <div class="page-title-section">
                    <h1 class="page-title">
                        <i class="fas fa-cog"></i>
                        Settings
                    </h1>
                    <p class="page-subtitle">Manage your account preferences</p>
                </div>
            </div>

            
            <div class="flash-messages">
                <div th:if="${successMessage}" class="flash-message flash-success">
                    <i class="fas fa-check-circle"></i>
                    <span th:text="${successMessage}">Success message</span>
                </div>
                <div th:if="${errorMessage}" class="flash-message flash-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span th:text="${errorMessage}">Error message</span>
                </div>
            </div>

            
            <div class="settings-sections">
                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-user"></i>
                            Update Profile
                        </h2>
                    </div>

                    <form th:action="@{/settings/profile}" method="post" class="settings-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-id-card"></i>
                                Username
                            </label>
                            <div class="username-field-container">
                                <input type="text"
                                       name="username"
                                       id="usernameInput"
                                       class="form-input username-input"
                                       th:value="${username}"
                                       placeholder="Enter your username"
                                       maxlength="64"
                                       readonly>
                                <button type="button" id="editUsernameBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                            <small class="form-help">Max 64 characters</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-signature"></i>
                                First Name
                            </label>
                            <div class="username-field-container">
                                <input type="text"
                                       name="firstName"
                                       id="firstNameInput"
                                       class="form-input username-input"
                                       th:value="${firstName}"
                                       placeholder="Enter your first name"
                                       maxlength="100"
                                       readonly>
                                <button type="button" id="editFirstNameBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-signature"></i>
                                Last Name
                            </label>
                            <div class="username-field-container">
                                <input type="text"
                                       name="lastName"
                                       id="lastNameInput"
                                       class="form-input username-input"
                                       th:value="${lastName}"
                                       placeholder="Enter your last name"
                                       maxlength="100"
                                       readonly>
                                <button type="button" id="editLastNameBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="saveUsernameBtn" class="btn btn-primary save-btn" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                            <button type="button" id="cancelUsernameBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" id="saveFirstNameBtn" class="btn btn-primary save-btn" formaction="/settings/update-first-name" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                            <button type="button" id="cancelFirstNameBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" id="saveLastNameBtn" class="btn btn-primary save-btn" formaction="/settings/update-last-name" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                            <button type="button" id="cancelLastNameBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Notifications -->
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-bell"></i>
                            Notifications
                        </h2>
                        <p class="section-description">Enable push reminders for workouts.</p>
                    </div>
                    <div class="notification-actions">
                        <button type="button" id="enable-notifications" class="btn btn-primary">
                            <i class="fas fa-toggle-on"></i>
                            Enable Notifications
                        </button>
                        <button type="button" id="disable-notifications" class="btn btn-outline">
                            <i class="fas fa-toggle-off"></i>
                            Disable Notifications
                        </button>
                        <button type="button" id="send-test-notification" class="btn btn-secondary">
                            <i class="fas fa-paper-plane"></i>
                            Send Test (10s)
                        </button>
                    </div>
                </div>

                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-user-circle"></i>
                            Personal Information
                        </h2>
                    </div>

                    <!-- Height -->
                    <div class="field-container">
                        <label class="field-label">
                            <i class="fas fa-ruler-vertical"></i>
                            Height (cm)
                        </label>
                        <div class="field-display" th:text="${heightCm != null ? heightCm : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="height">Edit</button>
                    </div>

                    <!-- Weight -->
                    <div class="field-container">
                        <label class="field-label">
                            <i class="fas fa-weight"></i>
                            Weight (kg)
                        </label>
                        <div class="field-display" th:text="${weightKg != null ? weightKg : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="weight">Edit</button>
                    </div>

                    <!-- Goal -->
                    <div class="field-container">
                        <label class="field-label">
                            <i class="fas fa-bullseye"></i>
                            Goal
                        </label>
                        <div class="field-display" th:text="${goal != null ? (goal == 'LOSE_WEIGHT' ? 'Lose Weight' : (goal == 'MAINTAIN_WEIGHT' ? 'Maintain Weight' : (goal == 'GAIN_WEIGHT' ? 'Gain Weight' : goal))) : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="goal">Edit</button>
                    </div>

                    <!-- Desired Weight (shown if goal is not MAINTAIN_WEIGHT) -->
                    <div class="field-container" th:if="${goal != 'MAINTAIN_WEIGHT'}">
                        <label class="field-label">
                            <i class="fas fa-balance-scale"></i>
                            Desired Weight (kg)
                        </label>
                        <div class="field-display" th:text="${desiredWeightKg != null ? desiredWeightKg : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="desiredWeight">Edit</button>
                    </div>

                    <!-- Weight Change Speed (shown if goal is not MAINTAIN_WEIGHT) -->
                    <div class="field-container" th:if="${goal != 'MAINTAIN_WEIGHT'}">
                        <label class="field-label">
                            <i class="fas fa-tachometer-alt"></i>
                            Weight Change Speed (kg/week)
                        </label>
                        <div class="field-display" th:text="${weightChangeSpeedKg != null ? weightChangeSpeedKg + ' kg/week' : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="weightSpeed">Edit</button>
                    </div>

                    <!-- Workout Frequency -->
                    <div class="field-container">
                        <label class="field-label">
                            <i class="fas fa-calendar-check"></i>
                            Workout Frequency
                        </label>
                        <div class="field-display" th:text="${workoutFrequency != null ? workoutFrequency : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="workoutFrequency">Edit</button>
                    </div>

                    <!-- Timezone -->
                    <div class="field-container">
                        <label class="field-label">
                            <i class="fas fa-globe"></i>
                            Timezone
                        </label>
                        <div class="field-display" th:text="${region != null ? region : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="timezone">Edit</button>
                    </div>
                </div>

                <!-- Edit Modal -->
                <div id="editModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modalTitle">Edit Field</h3>
                            <button type="button" class="close-modal-btn" id="closeModalBtn">&times;</button>
                        </div>
                        <div class="modal-body" id="modalBody">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline cancel-btn" id="modalCancelBtn">Cancel</button>
                            <button type="button" class="btn btn-primary" id="modalSaveBtn">Save</button>
                        </div>
                    </div>
                </div>

                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-image"></i>
                            Profile Picture
                        </h2>
                    </div>

                    <div class="avatar-section">
                        
                        <div class="avatar-preview" th:if="${avatarPath}">
                            <img th:src="${avatarPath}" alt="Profile Picture" class="avatar-image">
                        </div>

                        <div class="avatar-preview" th:unless="${avatarPath}">
                            <div class="avatar-placeholder">
                                <i class="fas fa-user"></i>
                                <span>No profile picture</span>
                            </div>
                        </div>

                        
                        <form th:action="@{/settings/avatar-url}" method="post" class="avatar-form">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-link"></i>
                                Avatar Image URL
                            </label>
                            <div class="avatar-field-container">
                                <input type="url"
                                       name="avatarUrl"
                                       id="avatarUrlInput"
                                       class="form-input avatar-input"
                                       th:value="${avatarPath}"
                                       placeholder="https://example.com/your-image.jpg"
                                       readonly>
                                <button type="button" id="editAvatarBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                            <small class="form-help">Use a direct image URL (http/https).</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="saveAvatarBtn" class="btn btn-primary save-btn" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save URL
                            </button>
                            <button type="button" id="cancelAvatarBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>

                    
                    <div th:if="${avatarPath}" class="remove-avatar-section" id="removeAvatarSection" style="display: none;">
                        <form th:action="@{/settings/avatar/delete}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-outline btn-danger">
                                <i class="fas fa-trash"></i>
                                Remove Avatar
                            </button>
                        </form>
                    </div>
                    </div>
                </div>

                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-lock"></i>
                            Change Password
                        </h2>
                    </div>

                    <div class="password-section">
                        <div class="password-field-container">
                            <div class="password-display">
                                <span class="password-mask">••••••••</span>
                                <button type="button" id="editPasswordBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <form th:action="@{/settings/password}" method="post" class="settings-form password-form" style="display: none;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-key"></i>
                                    Current Password
                                </label>
                                <input type="password" name="currentPassword" id="currentPasswordInput" class="form-input"
                                       placeholder="Enter current password" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-lock"></i>
                                    New Password
                                </label>
                                <input type="password" name="newPassword" id="newPasswordInput" class="form-input"
                                       placeholder="Enter new password" minlength="8" required>
                                <small class="form-help">Minimum 8 characters</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-lock"></i>
                                    Confirm New Password
                                </label>
                                <input type="password" name="confirmPassword" id="confirmPasswordInput" class="form-input"
                                       placeholder="Confirm new password" minlength="8" required>
                            </div>

                            <div class="form-actions">
                                <button type="submit" id="savePasswordBtn" class="btn btn-primary save-btn">
                                    <i class="fas fa-save"></i>
                                    Change Password
                                </button>
                                <button type="button" id="cancelPasswordBtn" class="btn btn-outline cancel-btn">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                            </div>
                        </form>
                        
                        <div class="password-edit-actions" style="display: none; margin-top: 1rem; text-align: center;">
                            <button type="button" id="cancelPasswordEditBtn" class="btn btn-outline cancel-btn">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
  (function() {
    async function getOrRegisterSW() {
      if (!('serviceWorker' in navigator)) return null;
      const reg = await navigator.serviceWorker.register('/sw.js');
      await navigator.serviceWorker.ready;
      return reg;
    }

    async function subscribe() {
      try {
        if (!('Notification' in window) || !('serviceWorker' in navigator)) {
          alert('Notifications are not supported in this browser.');
          return;
        }
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') {
          alert('Please allow notifications to enable reminders.');
          return;
        }
        const reg = await getOrRegisterSW();
        if (!reg || !('pushManager' in reg)) {
          alert('Push not supported.');
          return;
        }
        // Fetch VAPID public key from backend
        let appServerKey;
        try {
          const res = await fetch('/api/notifications/vapid-public-key');
          if (res.ok) {
            const vapidKey = await res.text();
            if (vapidKey && vapidKey.length > 0) {
              appServerKey = urlBase64ToUint8Array(vapidKey);
            }
          }
        } catch(_) {}
        const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
        const payload = {
          endpoint: sub.endpoint,
          p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(sub.getKey('p256dh')))),
          auth: btoa(String.fromCharCode.apply(null, new Uint8Array(sub.getKey('auth')))),
          userAgent: navigator.userAgent,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };
        const csrfHeaderName = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const headers = { 'Content-Type': 'application/json' };
        if (csrfHeaderName && csrfToken) headers[csrfHeaderName] = csrfToken;
        await fetch('/api/notifications/subscribe', {
          method: 'POST',
          headers,
          body: JSON.stringify(payload)
        });
        alert('Notifications enabled.');
      } catch (e) {
        console.error(e);
        alert('Could not enable notifications.');
      }
    }

    async function unsubscribe() {
      try {
        const reg = await navigator.serviceWorker.getRegistration();
        if (!reg) return;
        const sub = await reg.pushManager.getSubscription();
        if (sub) {
          const csrfHeaderName = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
          const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
          const headers = { 'Content-Type': 'application/json' };
          if (csrfHeaderName && csrfToken) headers[csrfHeaderName] = csrfToken;
          await fetch('/api/notifications/subscribe', {
            method: 'DELETE',
            headers,
            body: JSON.stringify({ endpoint: sub.endpoint })
          });
          await sub.unsubscribe();
          alert('Notifications disabled.');
        }
      } catch (e) {
        console.error(e);
      }
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Simple hooks if buttons exist on page
    const enableBtn = document.getElementById('enable-notifications');
    if (enableBtn) enableBtn.addEventListener('click', subscribe);
    const disableBtn = document.getElementById('disable-notifications');
    if (disableBtn) disableBtn.addEventListener('click', unsubscribe);
    const testBtn = document.getElementById('send-test-notification');
    if (testBtn) testBtn.addEventListener('click', async function() {
      try {
        const csrfHeaderName = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const headers = { 'Content-Type': 'application/json' };
        if (csrfHeaderName && csrfToken) headers[csrfHeaderName] = csrfToken;
        const res = await fetch('/api/notifications/test', { method: 'POST', headers });
        if (res.ok) {
          alert('Test notification scheduled. You should receive it in ~10 seconds.');
        } else {
          const t = await res.text();
          alert('Could not schedule test: ' + t);
        }
      } catch (e) {
        alert('Error scheduling test notification.');
      }
    });
  })();
</script>

<script>
// Function to show error messages in the UI
function showErrorMessage(message) {
    const form = document.querySelector('.settings-form');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'flash-message flash-error';
    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>' + message + '</span>';

    // Insert after the flash-messages div
    const flashMessages = document.querySelector('.flash-messages');
    flashMessages.appendChild(errorDiv);

    // Auto-hide after 5 seconds
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    const editBtn = document.getElementById('editUsernameBtn');
    const saveBtn = document.getElementById('saveUsernameBtn');
    const cancelBtn = document.getElementById('cancelUsernameBtn');
    const usernameInput = document.getElementById('usernameInput');
    const originalValue = usernameInput.value;

    // Edit button click handler
    editBtn.addEventListener('click', function() {
        // Enable input field
        usernameInput.removeAttribute('readonly');
        usernameInput.focus();
        
        // Show save and cancel buttons, hide edit button
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-flex';
        cancelBtn.style.display = 'inline-flex';
        
        // Add visual indication that field is editable
        usernameInput.classList.add('editing');
    });

    // Cancel button click handler
    cancelBtn.addEventListener('click', function() {
        // Restore original value
        usernameInput.value = originalValue;
        
        // Make input readonly again
        usernameInput.setAttribute('readonly', true);
        usernameInput.classList.remove('editing');
        
        // Show edit button, hide save and cancel buttons
        editBtn.style.display = 'inline-flex';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    });

    // Save button functionality (form submission)
    saveBtn.addEventListener('click', function(e) {
        // The form will submit normally since it's a submit button
        // Add any validation here if needed
        const newValue = usernameInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('Username cannot be empty');
            return;
        }
        if (newValue === originalValue) {
            e.preventDefault();
            showErrorMessage('No changes made');
            // Reset to edit mode
            cancelBtn.click();
            return;
        }
    });

    // Handle Enter key in input field
    usernameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !usernameInput.hasAttribute('readonly')) {
            e.preventDefault();
            saveBtn.click();
        }
        if (e.key === 'Escape' && !usernameInput.hasAttribute('readonly')) {
            e.preventDefault();
            cancelBtn.click();
        }
    });

    // Avatar functionality
    const editAvatarBtn = document.getElementById('editAvatarBtn');
    const saveAvatarBtn = document.getElementById('saveAvatarBtn');
    const cancelAvatarBtn = document.getElementById('cancelAvatarBtn');
    const avatarUrlInput = document.getElementById('avatarUrlInput');
    const originalAvatarValue = avatarUrlInput.value;

    editAvatarBtn.addEventListener('click', function() {
        avatarUrlInput.removeAttribute('readonly');
        avatarUrlInput.focus();
        
        editAvatarBtn.style.display = 'none';
        saveAvatarBtn.style.display = 'inline-flex';
        cancelAvatarBtn.style.display = 'inline-flex';
        
        // Show remove avatar button in edit mode
        const removeAvatarSection = document.getElementById('removeAvatarSection');
        if (removeAvatarSection) {
            removeAvatarSection.style.display = 'block';
        }
        
        avatarUrlInput.classList.add('editing');
    });

    cancelAvatarBtn.addEventListener('click', function() {
        avatarUrlInput.value = originalAvatarValue;
        avatarUrlInput.setAttribute('readonly', true);
        avatarUrlInput.classList.remove('editing');
        
        // Hide remove avatar button when canceling
        const removeAvatarSection = document.getElementById('removeAvatarSection');
        if (removeAvatarSection) {
            removeAvatarSection.style.display = 'none';
        }
        
        editAvatarBtn.style.display = 'inline-flex';
        saveAvatarBtn.style.display = 'none';
        cancelAvatarBtn.style.display = 'none';
    });

    saveAvatarBtn.addEventListener('click', function(e) {
        const newValue = avatarUrlInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('Avatar URL cannot be empty');
            return;
        }
        if (newValue === originalAvatarValue) {
            e.preventDefault();
            showErrorMessage('No changes made');
            cancelAvatarBtn.click();
            return;
        }
    });

    // Password functionality
    const editPasswordBtn = document.getElementById('editPasswordBtn');
    const savePasswordBtn = document.getElementById('savePasswordBtn');
    const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
    const cancelPasswordEditBtn = document.getElementById('cancelPasswordEditBtn');
    const passwordDisplay = document.querySelector('.password-display');
    const passwordForm = document.querySelector('.password-form');
    const passwordEditActions = document.querySelector('.password-edit-actions');

    editPasswordBtn.addEventListener('click', function() {
        passwordDisplay.style.display = 'none';
        passwordForm.style.display = 'block';
        passwordEditActions.style.display = 'block';
        
        document.getElementById('currentPasswordInput').focus();
    });

    cancelPasswordBtn.addEventListener('click', function() {
        passwordDisplay.style.display = 'block';
        passwordEditActions.style.display = 'none';
        passwordForm.style.display = 'none';
        
        // Clear form fields
        document.getElementById('currentPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
    });

    cancelPasswordEditBtn.addEventListener('click', function() {
        passwordDisplay.style.display = 'block';
        passwordEditActions.style.display = 'none';
        passwordForm.style.display = 'none';
        
        // Clear form fields
        document.getElementById('currentPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
    });

    savePasswordBtn.addEventListener('click', function(e) {
        const currentPassword = document.getElementById('currentPasswordInput').value.trim();
        const newPassword = document.getElementById('newPasswordInput').value.trim();
        const confirmPassword = document.getElementById('confirmPasswordInput').value.trim();

        if (currentPassword === '') {
            e.preventDefault();
            showErrorMessage('Current password is required');
            return;
        }
        if (newPassword === '') {
            e.preventDefault();
            showErrorMessage('New password is required');
            return;
        }
        if (newPassword.length < 8) {
            e.preventDefault();
            showErrorMessage('New password must be at least 8 characters long');
            return;
        }
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            showErrorMessage('New passwords do not match');
            return;
        }
    });

    // First Name functionality
    const editFirstNameBtn = document.getElementById('editFirstNameBtn');
    const saveFirstNameBtn = document.getElementById('saveFirstNameBtn');
    const cancelFirstNameBtn = document.getElementById('cancelFirstNameBtn');
    const firstNameInput = document.getElementById('firstNameInput');
    const originalFirstName = firstNameInput.value;

    editFirstNameBtn.addEventListener('click', function() {
        firstNameInput.removeAttribute('readonly');
        firstNameInput.focus();
        editFirstNameBtn.style.display = 'none';
        saveFirstNameBtn.style.display = 'inline-flex';
        cancelFirstNameBtn.style.display = 'inline-flex';
        firstNameInput.classList.add('editing');
    });

    cancelFirstNameBtn.addEventListener('click', function() {
        firstNameInput.value = originalFirstName;
        firstNameInput.setAttribute('readonly', true);
        firstNameInput.classList.remove('editing');
        editFirstNameBtn.style.display = 'inline-flex';
        saveFirstNameBtn.style.display = 'none';
        cancelFirstNameBtn.style.display = 'none';
    });

    saveFirstNameBtn.addEventListener('click', function(e) {
        const newValue = firstNameInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('First name cannot be empty');
            return;
        }
        if (newValue === originalFirstName) {
            e.preventDefault();
            showErrorMessage('No changes made');
            cancelFirstNameBtn.click();
            return;
        }
    });

    // Last Name functionality
    const editLastNameBtn = document.getElementById('editLastNameBtn');
    const saveLastNameBtn = document.getElementById('saveLastNameBtn');
    const cancelLastNameBtn = document.getElementById('cancelLastNameBtn');
    const lastNameInput = document.getElementById('lastNameInput');
    const originalLastName = lastNameInput.value;

    editLastNameBtn.addEventListener('click', function() {
        lastNameInput.removeAttribute('readonly');
        lastNameInput.focus();
        editLastNameBtn.style.display = 'none';
        saveLastNameBtn.style.display = 'inline-flex';
        cancelLastNameBtn.style.display = 'inline-flex';
        lastNameInput.classList.add('editing');
    });

    cancelLastNameBtn.addEventListener('click', function() {
        lastNameInput.value = originalLastName;
        lastNameInput.setAttribute('readonly', true);
        lastNameInput.classList.remove('editing');
        editLastNameBtn.style.display = 'inline-flex';
        saveLastNameBtn.style.display = 'none';
        cancelLastNameBtn.style.display = 'none';
    });

    saveLastNameBtn.addEventListener('click', function(e) {
        const newValue = lastNameInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('Last name cannot be empty');
            return;
        }
        if (newValue === originalLastName) {
            e.preventDefault();
            showErrorMessage('No changes made');
            cancelLastNameBtn.click();
            return;
        }
    });

    // Personal Information fields functionality
    const editModal = document.getElementById('editModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    let currentFieldType = null;
    let currentFieldContainer = null;
    let selectedValue = null;

    function openModal(fieldType, title, options) {
        currentFieldType = fieldType;
        modalTitle.textContent = title;
        modalBody.innerHTML = '';
        selectedValue = null;
        
        // Show modal footer
        document.querySelector('.modal-footer').style.display = 'flex';
        
        options.forEach(option => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'option-btn';
            button.textContent = option.label;
            button.value = option.value;
            button.addEventListener('click', function() {
                if (option.value === 'custom') {
                    showCustomInput(fieldType);
                } else {
                    selectedValue = option.value;
                    submitFieldUpdate();
                    closeModal();
                }
            });
            modalBody.appendChild(button);
        });
        
        editModal.style.display = 'block';
    }

    function selectOption(value) {
        submitFieldUpdate();
        closeModal();
    }

    function showCustomInput(fieldType) {
        let label = '';
        switch(fieldType) {
            case 'height': label = 'Enter your height (cm):'; break;
            case 'weight': label = 'Enter your weight (kg):'; break;
            case 'desiredWeight': label = 'Enter your desired weight (kg):'; break;
            case 'weightSpeed': label = 'Enter weight change speed (kg/week):'; break;
        }
        
        modalBody.innerHTML = `
            <div class="custom-input-container">
                <label class="custom-input-label" th:remove="tag">${label}</label>
                <input type="text" id="customInput" class="form-input" placeholder="Enter value">
                <div class="custom-input-actions">
                    <button type="button" class="btn btn-outline" id="cancelCustomBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCustomBtn">Save</button>
                </div>
            </div>
        `;
        
        // Hide modal footer
        document.querySelector('.modal-footer').style.display = 'none';
        
        const customInput = document.getElementById('customInput');
        const saveCustomBtn = document.getElementById('saveCustomBtn');
        const cancelCustomBtn = document.getElementById('cancelCustomBtn');
        
        saveCustomBtn.addEventListener('click', function() {
            const value = customInput.value.trim();
            if (value !== '' && !isNaN(value)) {
                selectedValue = value;
                submitFieldUpdate();
                closeModal();
            }
        });
        
        cancelCustomBtn.addEventListener('click', function() {
            closeModal();
        });
        
        customInput.focus();
    }

    function closeModal() {
        editModal.style.display = 'none';
        modalBody.innerHTML = '';
        currentFieldType = null;
        currentFieldContainer = null;
    }

    modalCancelBtn.addEventListener('click', closeModal);
    closeModalBtn.addEventListener('click', closeModal);

    // Click outside modal to close
    editModal.addEventListener('click', function(e) {
        if (e.target === editModal) {
            closeModal();
        }
    });

    const editFieldBtns = document.querySelectorAll('.edit-field-btn');
    
    editFieldBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const fieldType = this.getAttribute('data-field');
            currentFieldContainer = this.closest('.field-container');
            
            switch(fieldType) {
                case 'height':
                    openModal(fieldType, 'Enter your height in cm', [
                        {label: '100 cm', value: '100'},
                        {label: '110 cm', value: '110'},
                        {label: '120 cm', value: '120'},
                        {label: '130 cm', value: '130'},
                        {label: '140 cm', value: '140'},
                        {label: '150 cm', value: '150'},
                        {label: '160 cm', value: '160'},
                        {label: '170 cm', value: '170'},
                        {label: '180 cm', value: '180'},
                        {label: '190 cm', value: '190'},
                        {label: '200 cm', value: '200'},
                        {label: '210 cm', value: '210'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'weight':
                    openModal(fieldType, 'Enter your weight in kg', [
                        {label: '40 kg', value: '40'},
                        {label: '50 kg', value: '50'},
                        {label: '60 kg', value: '60'},
                        {label: '70 kg', value: '70'},
                        {label: '80 kg', value: '80'},
                        {label: '90 kg', value: '90'},
                        {label: '100 kg', value: '100'},
                        {label: '110 kg', value: '110'},
                        {label: '120 kg', value: '120'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'goal':
                    openModal(fieldType, 'Select your goal', [
                        {label: 'Lose Weight', value: 'LOSE_WEIGHT'},
                        {label: 'Maintain Weight', value: 'MAINTAIN_WEIGHT'},
                        {label: 'Gain Weight', value: 'GAIN_WEIGHT'}
                    ]);
                    break;
                case 'desiredWeight':
                    openModal(fieldType, 'Enter your desired weight in kg', [
                        {label: '50 kg', value: '50'},
                        {label: '60 kg', value: '60'},
                        {label: '70 kg', value: '70'},
                        {label: '80 kg', value: '80'},
                        {label: '90 kg', value: '90'},
                        {label: '100 kg', value: '100'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'weightSpeed':
                    openModal(fieldType, 'Enter your weight change speed in kg/week', [
                        {label: '0.1 kg/week', value: '0.1'},
                        {label: '0.2 kg/week', value: '0.2'},
                        {label: '0.3 kg/week', value: '0.3'},
                        {label: '0.4 kg/week', value: '0.4'},
                        {label: '0.5 kg/week', value: '0.5'},
                        {label: '0.6 kg/week', value: '0.6'},
                        {label: '0.7 kg/week', value: '0.7'},
                        {label: '0.8 kg/week', value: '0.8'},
                        {label: '0.9 kg/week', value: '0.9'},
                        {label: '1.0 kg/week', value: '1.0'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'workoutFrequency':
                    openModal(fieldType, 'Select workout frequency', [
                        {label: 'Low (0-2 days/week)', value: 'LOW'},
                        {label: 'Medium (3-5 days/week)', value: 'MEDIUM'},
                        {label: 'High (6+ days/week)', value: 'HIGH'}
                    ]);
                    break;
                case 'timezone':
                    openModal(fieldType, 'Select your timezone', [
                        {label: 'Europe', value: 'Europe'},
                        {label: 'North America', value: 'North America'},
                        {label: 'Asia', value: 'Asia'},
                        {label: 'Africa', value: 'Africa'},
                        {label: 'Oceania', value: 'Oceania'},
                        {label: 'South America', value: 'South America'}
                    ]);
                    break;
            }
        });
    });

    function submitFieldUpdate() {
        let url, paramName, paramValue;
        
        switch(currentFieldType) {
            case 'height':
                url = '/settings/update-height';
                paramName = 'heightCm';
                paramValue = parseInt(selectedValue);
                break;
            case 'weight':
                url = '/settings/update-weight';
                paramName = 'weightKg';
                paramValue = parseInt(selectedValue);
                break;
            case 'goal':
                url = '/settings/update-goal';
                paramName = 'goal';
                paramValue = selectedValue;
                break;
            case 'desiredWeight':
                url = '/settings/update-desired-weight';
                paramName = 'desiredWeightKg';
                paramValue = parseInt(selectedValue);
                break;
            case 'weightSpeed':
                url = '/settings/update-weight-speed';
                paramName = 'weightChangeSpeedKg';
                paramValue = parseFloat(selectedValue);
                break;
            case 'workoutFrequency':
                url = '/settings/update-workout-frequency';
                paramName = 'workoutFrequency';
                paramValue = selectedValue;
                break;
            case 'timezone':
                url = '/settings/update-timezone';
                paramName = 'region';
                paramValue = selectedValue;
                break;
            default:
                return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = url;
        
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = document.querySelector('meta[name="_csrf_parameter"]').getAttribute('content');
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        const valueInput = document.createElement('input');
        valueInput.type = 'hidden';
        valueInput.name = paramName;
        valueInput.value = paramValue;
        form.appendChild(valueInput);
        
        document.body.appendChild(form);
        form.submit();
    }
    
    // Prevent overscrolling by clamping scroll position
    function clampScrollPosition() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = Math.max(
            document.body.scrollHeight,
            document.body.offsetHeight,
            document.documentElement.clientHeight,
            document.documentElement.scrollHeight,
            document.documentElement.offsetHeight
        );
        const clientHeight = window.innerHeight || document.documentElement.clientHeight;
        const maxScroll = Math.max(0, scrollHeight - clientHeight);
        
        if (scrollTop < 0) {
            window.scrollTo(0, 0);
        } else if (scrollTop > maxScroll) {
            window.scrollTo(0, maxScroll);
        }
    }
    
    let scrollTimeout;
    function handleScroll() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(clampScrollPosition, 10);
    }
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('touchmove', handleScroll, { passive: true });
    window.addEventListener('wheel', handleScroll, { passive: true });
    
    document.addEventListener('DOMContentLoaded', function() {
        clampScrollPosition();
        window.addEventListener('resize', function() {
            setTimeout(clampScrollPosition, 100);
        });
    });
});
</script>

</body>
</html>