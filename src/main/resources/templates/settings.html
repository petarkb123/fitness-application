<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FitPower - Settings</title>
    <link rel="stylesheet" th:href="@{/css/desktop/settings.css}">
    <link rel="stylesheet" th:href="@{/css/mobile/settings-mobile.css}" media="(max-width: 480px)">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
<div class="dashboard-container">
    
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <i class="fas fa-dumbbell"></i>
                <span>FitPower</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">MAIN MENU</h3>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/dashboard" class="nav-link">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/exercises" class="nav-link">
                            <i class="fas fa-dumbbell"></i>
                            <span>Exercises</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/workouts" class="nav-link">
                            <i class="fas fa-history"></i>
                            <span>Workouts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/templates" class="nav-link">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Templates</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/stats/weekly" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Statistics</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">ACCOUNT</h3>
                <ul class="nav-list">
                    <li class="nav-item active">
                        <a href="/settings" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <form th:action="@{/logout}" method="post" style="display:inline;">
                            <button type="submit" class="nav-link" style="background:none; border:none; width:100%; text-align:left;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        </form>
                    </li>
                </ul>
            </div>
        </nav>
    </aside>

    
    <main class="main-content">
        
        <header class="top-header">
            <div class="header-left">
                <h1 class="page-title">Settings</h1>
            </div>
            <div class="header-right">
                <div class="user-profile">
                    <div class="profile-avatar avatar-preview">
                        <img th:if="${navAvatar}" th:src="${navAvatar}" alt="Profile Picture" class="avatar-image">
                        <div class="avatar-placeholder" th:unless="${navAvatar}" style="display:flex;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <span class="profile-name" th:text="${username}">User</span>
                    </div>
                </div>
            </div>
        </header>

        
        <div class="dashboard-content">
            
            <div class="page-header">
                <div class="page-title-section">
                    <h1 class="page-title">
                        <i class="fas fa-cog"></i>
                        Settings
                    </h1>
                    <p class="page-subtitle">Manage your account preferences</p>
                </div>
            </div>

            
            <div class="flash-messages">
                <div th:if="${successMessage}" class="flash-message flash-success">
                    <i class="fas fa-check-circle"></i>
                    <span th:text="${successMessage}">Success message</span>
                </div>
                <div th:if="${errorMessage}" class="flash-message flash-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span th:text="${errorMessage}">Error message</span>
                </div>
            </div>

            
            <div class="settings-sections">
                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-user"></i>
                            Update Profile
                        </h2>
                    </div>

                    <form th:action="@{/settings/profile}" method="post" class="settings-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-id-card"></i>
                                Username
                            </label>
                            <div class="username-field-container">
                                <input type="text"
                                       name="username"
                                       id="usernameInput"
                                       class="form-input username-input"
                                       th:value="${username}"
                                       placeholder="Enter your username"
                                       maxlength="64"
                                       readonly>
                                <button type="button" id="editUsernameBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                            <small class="form-help">Max 64 characters</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="saveUsernameBtn" class="btn btn-primary save-btn" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                            <button type="button" id="cancelUsernameBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>

                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-image"></i>
                            Profile Picture
                        </h2>
                    </div>

                    <div class="avatar-section">
                        
                        <div class="avatar-preview" th:if="${avatarPath}">
                            <img th:src="${avatarPath}" alt="Profile Picture" class="avatar-image">
                        </div>

                        <div class="avatar-preview" th:unless="${avatarPath}">
                            <div class="avatar-placeholder">
                                <i class="fas fa-user"></i>
                                <span>No profile picture</span>
                            </div>
                        </div>

                        
                        <form th:action="@{/settings/avatar-url}" method="post" class="avatar-form">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-link"></i>
                                Avatar Image URL
                            </label>
                            <div class="avatar-field-container">
                                <input type="url"
                                       name="avatarUrl"
                                       id="avatarUrlInput"
                                       class="form-input avatar-input"
                                       th:value="${avatarPath}"
                                       placeholder="https://example.com/your-image.jpg"
                                       readonly>
                                <button type="button" id="editAvatarBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                            <small class="form-help">Use a direct image URL (http/https).</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="saveAvatarBtn" class="btn btn-primary save-btn" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save URL
                            </button>
                            <button type="button" id="cancelAvatarBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>

                    
                    <div th:if="${avatarPath}" class="remove-avatar-section" id="removeAvatarSection" style="display: none;">
                        <form th:action="@{/settings/avatar/delete}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-outline btn-danger">
                                <i class="fas fa-trash"></i>
                                Remove Avatar
                            </button>
                        </form>
                    </div>
                    </div>
                </div>

                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-lock"></i>
                            Change Password
                        </h2>
                    </div>

                    <div class="password-section">
                        <div class="password-field-container">
                            <div class="password-display">
                                <span class="password-mask">••••••••</span>
                                <button type="button" id="editPasswordBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <form th:action="@{/settings/password}" method="post" class="settings-form password-form" style="display: none;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-key"></i>
                                    Current Password
                                </label>
                                <input type="password" name="currentPassword" id="currentPasswordInput" class="form-input"
                                       placeholder="Enter current password" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-lock"></i>
                                    New Password
                                </label>
                                <input type="password" name="newPassword" id="newPasswordInput" class="form-input"
                                       placeholder="Enter new password" minlength="8" required>
                                <small class="form-help">Minimum 8 characters</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-lock"></i>
                                    Confirm New Password
                                </label>
                                <input type="password" name="confirmPassword" id="confirmPasswordInput" class="form-input"
                                       placeholder="Confirm new password" minlength="8" required>
                            </div>

                            <div class="form-actions">
                                <button type="submit" id="savePasswordBtn" class="btn btn-primary save-btn">
                                    <i class="fas fa-save"></i>
                                    Change Password
                                </button>
                                <button type="button" id="cancelPasswordBtn" class="btn btn-outline cancel-btn">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                            </div>
                        </form>
                        
                        <div class="password-edit-actions" style="display: none; margin-top: 1rem; text-align: center;">
                            <button type="button" id="cancelPasswordEditBtn" class="btn btn-outline cancel-btn">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// Function to show error messages in the UI
function showErrorMessage(message) {
    const form = document.querySelector('.settings-form');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'flash-message flash-error';
    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>' + message + '</span>';

    // Insert after the flash-messages div
    const flashMessages = document.querySelector('.flash-messages');
    flashMessages.appendChild(errorDiv);

    // Auto-hide after 5 seconds
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    const editBtn = document.getElementById('editUsernameBtn');
    const saveBtn = document.getElementById('saveUsernameBtn');
    const cancelBtn = document.getElementById('cancelUsernameBtn');
    const usernameInput = document.getElementById('usernameInput');
    const originalValue = usernameInput.value;

    // Edit button click handler
    editBtn.addEventListener('click', function() {
        // Enable input field
        usernameInput.removeAttribute('readonly');
        usernameInput.focus();
        
        // Show save and cancel buttons, hide edit button
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-flex';
        cancelBtn.style.display = 'inline-flex';
        
        // Add visual indication that field is editable
        usernameInput.classList.add('editing');
    });

    // Cancel button click handler
    cancelBtn.addEventListener('click', function() {
        // Restore original value
        usernameInput.value = originalValue;
        
        // Make input readonly again
        usernameInput.setAttribute('readonly', true);
        usernameInput.classList.remove('editing');
        
        // Show edit button, hide save and cancel buttons
        editBtn.style.display = 'inline-flex';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    });

    // Save button functionality (form submission)
    saveBtn.addEventListener('click', function(e) {
        // The form will submit normally since it's a submit button
        // Add any validation here if needed
        const newValue = usernameInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('Username cannot be empty');
            return;
        }
        if (newValue === originalValue) {
            e.preventDefault();
            showErrorMessage('No changes made');
            // Reset to edit mode
            cancelBtn.click();
            return;
        }
    });

    // Handle Enter key in input field
    usernameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !usernameInput.hasAttribute('readonly')) {
            e.preventDefault();
            saveBtn.click();
        }
        if (e.key === 'Escape' && !usernameInput.hasAttribute('readonly')) {
            e.preventDefault();
            cancelBtn.click();
        }
    });

    // Avatar functionality
    const editAvatarBtn = document.getElementById('editAvatarBtn');
    const saveAvatarBtn = document.getElementById('saveAvatarBtn');
    const cancelAvatarBtn = document.getElementById('cancelAvatarBtn');
    const avatarUrlInput = document.getElementById('avatarUrlInput');
    const originalAvatarValue = avatarUrlInput.value;

    editAvatarBtn.addEventListener('click', function() {
        avatarUrlInput.removeAttribute('readonly');
        avatarUrlInput.focus();
        
        editAvatarBtn.style.display = 'none';
        saveAvatarBtn.style.display = 'inline-flex';
        cancelAvatarBtn.style.display = 'inline-flex';
        
        // Show remove avatar button in edit mode
        const removeAvatarSection = document.getElementById('removeAvatarSection');
        if (removeAvatarSection) {
            removeAvatarSection.style.display = 'block';
        }
        
        avatarUrlInput.classList.add('editing');
    });

    cancelAvatarBtn.addEventListener('click', function() {
        avatarUrlInput.value = originalAvatarValue;
        avatarUrlInput.setAttribute('readonly', true);
        avatarUrlInput.classList.remove('editing');
        
        // Hide remove avatar button when canceling
        const removeAvatarSection = document.getElementById('removeAvatarSection');
        if (removeAvatarSection) {
            removeAvatarSection.style.display = 'none';
        }
        
        editAvatarBtn.style.display = 'inline-flex';
        saveAvatarBtn.style.display = 'none';
        cancelAvatarBtn.style.display = 'none';
    });

    saveAvatarBtn.addEventListener('click', function(e) {
        const newValue = avatarUrlInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('Avatar URL cannot be empty');
            return;
        }
        if (newValue === originalAvatarValue) {
            e.preventDefault();
            showErrorMessage('No changes made');
            cancelAvatarBtn.click();
            return;
        }
    });

    // Password functionality
    const editPasswordBtn = document.getElementById('editPasswordBtn');
    const savePasswordBtn = document.getElementById('savePasswordBtn');
    const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
    const cancelPasswordEditBtn = document.getElementById('cancelPasswordEditBtn');
    const passwordDisplay = document.querySelector('.password-display');
    const passwordForm = document.querySelector('.password-form');
    const passwordEditActions = document.querySelector('.password-edit-actions');

    editPasswordBtn.addEventListener('click', function() {
        passwordDisplay.style.display = 'none';
        passwordForm.style.display = 'block';
        passwordEditActions.style.display = 'block';
        
        document.getElementById('currentPasswordInput').focus();
    });

    cancelPasswordBtn.addEventListener('click', function() {
        passwordDisplay.style.display = 'block';
        passwordEditActions.style.display = 'none';
        passwordForm.style.display = 'none';
        
        // Clear form fields
        document.getElementById('currentPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
    });

    cancelPasswordEditBtn.addEventListener('click', function() {
        passwordDisplay.style.display = 'block';
        passwordEditActions.style.display = 'none';
        passwordForm.style.display = 'none';
        
        // Clear form fields
        document.getElementById('currentPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
    });

    savePasswordBtn.addEventListener('click', function(e) {
        const currentPassword = document.getElementById('currentPasswordInput').value.trim();
        const newPassword = document.getElementById('newPasswordInput').value.trim();
        const confirmPassword = document.getElementById('confirmPasswordInput').value.trim();

        if (currentPassword === '') {
            e.preventDefault();
            showErrorMessage('Current password is required');
            return;
        }
        if (newPassword === '') {
            e.preventDefault();
            showErrorMessage('New password is required');
            return;
        }
        if (newPassword.length < 8) {
            e.preventDefault();
            showErrorMessage('New password must be at least 8 characters long');
            return;
        }
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            showErrorMessage('New passwords do not match');
            return;
        }
    });
});
</script>

</body>
</html>
