<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FitPower - Settings</title>
    <link rel="stylesheet" th:href="@{/css/desktop/settings.css}">
    <link rel="stylesheet" th:href="@{/css/mobile/settings-mobile.css}" media="(max-width: 480px)">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Polished, centered danger modal */
        #dangerModal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none; /* toggled via JS */
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1.25rem;
        }
        #dangerModal .modal-content {
            margin-top: 200px;
            width: 100%;
            max-width: 520px;
            background: linear-gradient(180deg, rgba(26,26,48,0.98) 0%, rgba(20,20,40,0.98) 100%);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            overflow: hidden;
        }
        #dangerModal .modal-header {
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        #dangerModal .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: .2px;
        }
        #dangerModal .modal-body {
            padding: 1rem 1.25rem;
            color: #cfd3ff;
            line-height: 1.5;
            margin-top: 0.35rem; /* nudge content a bit lower */
        }
        #dangerModal .modal-footer {
            padding: 0.9rem 1.25rem 1.15rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: .75rem; /* more space between buttons */
        }
        #dangerModal .confirm-phrase {
            color: #ff4d4f; /* only the phrase is red */
            font-weight: 700;
        }
        /* Wider buttons in the modal */
        #dangerForm .btn {
            min-width: 230px;
            margin-bottom: 10px;  
        }
        /* Shift the confirmation input a bit lower for breathing room */
        #dangerConfirmInput { margin-top: 0.5rem; }
    </style>
</head>
<body>
<div class="dashboard-container">
    
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <i class="fas fa-dumbbell"></i>
                <span>FitPower</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">MAIN MENU</h3>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/dashboard" class="nav-link">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/exercises" class="nav-link">
                            <i class="fas fa-dumbbell"></i>
                            <span>Exercises</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/workouts" class="nav-link">
                            <i class="fas fa-history"></i>
                            <span>Workouts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/templates" class="nav-link">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Templates</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/stats/weekly" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Statistics</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">ACCOUNT</h3>
                <ul class="nav-list">
                    <li class="nav-item active">
                        <a href="/settings" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <form th:action="@{/logout}" method="post" style="display:inline;">
                            <button type="submit" class="nav-link" style="background:none; border:none; width:100%; text-align:left;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        </form>
                    </li>
                </ul>
            </div>
        </nav>
    </aside>

    
    <main class="main-content">
        
        <header class="top-header">
            <div class="header-left">
                <!-- Mobile only: User profile above title -->
                <div class="user-profile mobile-profile">
                    <div class="profile-avatar avatar-preview">
                        <img th:if="${navAvatar}" th:src="${navAvatar}" alt="Profile Picture" class="avatar-image">
                        <div class="avatar-placeholder" th:unless="${navAvatar}" style="display:flex;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <span class="profile-name" th:text="${username}">User</span>
                    </div>
                </div>
                <h1 class="page-title">Settings</h1>
            </div>
            <div class="header-right">
                <!-- Desktop only: User profile in top right (original) -->
                <div class="user-profile desktop-profile">
                    <div class="profile-avatar avatar-preview">
                        <img th:if="${navAvatar}" th:src="${navAvatar}" alt="Profile Picture" class="avatar-image">
                        <div class="avatar-placeholder" th:unless="${navAvatar}" style="display:flex;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <span class="profile-name" th:text="${username}">User</span>
                    </div>
                </div>
                <!-- Mobile only: Home Page button -->
                <div class="header-actions">
                    <a href="/" class="header-btn">
                        <i class="fas fa-home"></i>
                        <span>Home Page</span>
                    </a>
                </div>
            </div>
        </header>

        
        <div class="dashboard-content">
            
            <div class="page-header">
                <div class="page-title-section">
                    <h1 class="page-title">
                        <i class="fas fa-cog"></i>
                        Settings
                    </h1>
                    <p class="page-subtitle">Manage your account preferences</p>
                </div>
            </div>

            
            <div class="flash-messages">
                <div th:if="${successMessage}" class="flash-message flash-success">
                    <i class="fas fa-check-circle"></i>
                    <span th:text="${successMessage}">Success message</span>
                </div>
                <div th:if="${errorMessage}" class="flash-message flash-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span th:text="${errorMessage}">Error message</span>
                </div>
            </div>

            
            <div class="settings-sections">
                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-user"></i>
                            Update Profile
                        </h2>
                    </div>

                    <form th:action="@{/settings/profile}" method="post" class="settings-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-id-card"></i>
                                Username
                            </label>
                            <div class="username-field-container">
                                <input type="text"
                                       name="username"
                                       id="usernameInput"
                                       class="form-input username-input"
                                       th:value="${username}"
                                       placeholder="Enter your username"
                                       maxlength="64"
                                       readonly>
                                <button type="button" id="editUsernameBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                            <small class="form-help">Max 64 characters</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-signature"></i>
                                First Name
                            </label>
                            <div class="username-field-container">
                                <input type="text"
                                       name="firstName"
                                       id="firstNameInput"
                                       class="form-input username-input"
                                       th:value="${firstName}"
                                       placeholder="Enter your first name"
                                       maxlength="100"
                                       readonly>
                                <button type="button" id="editFirstNameBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-signature"></i>
                                Last Name
                            </label>
                            <div class="username-field-container">
                                <input type="text"
                                       name="lastName"
                                       id="lastNameInput"
                                       class="form-input username-input"
                                       th:value="${lastName}"
                                       placeholder="Enter your last name"
                                       maxlength="100"
                                       readonly>
                                <button type="button" id="editLastNameBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-envelope"></i>
                                Email
                            </label>
                            <div class="username-field-container">
                                <input type="email"
                                       name="email"
                                       id="emailInput"
                                       class="form-input username-input"
                                       th:value="${email}"
                                       placeholder="Enter your email"
                                       maxlength="100"
                                       readonly>
                                <button type="button" id="editEmailBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="saveUsernameBtn" class="btn btn-primary save-btn" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                            <button type="button" id="cancelUsernameBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" id="saveFirstNameBtn" class="btn btn-primary save-btn" formaction="/settings/update-first-name" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                            <button type="button" id="cancelFirstNameBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" id="saveLastNameBtn" class="btn btn-primary save-btn" formaction="/settings/update-last-name" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                            <button type="button" id="cancelLastNameBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" id="saveEmailBtn" class="btn btn-primary save-btn" formaction="/settings/update-email" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                            <button type="button" id="cancelEmailBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>

               


                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-user-circle"></i>
                            Personal Information
                        </h2>
                    </div>

                    <!-- Unit System Toggle -->
                    <div class="field-container">
                        <label class="field-label">
                            <i class="fas fa-balance-scale"></i>
                            Units
                        </label>
                        <div class="field-display" th:text="${unitSystem == 'imperial' ? 'Imperial (ft/in, lb)' : 'Metric (cm, kg)'}">Metric (cm, kg)</div>
                        <form th:action="@{/settings/update-unit-system}" method="post" style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" name="unitSystem" value="metric"
                                    class="btn"
                                    th:classappend="${unitSystem != 'imperial'} ? ' btn-primary' : ' btn-outline'">
                                Metric (cm, kg)
                            </button>
                            <button type="submit" name="unitSystem" value="imperial"
                                    class="btn"
                                    th:classappend="${unitSystem == 'imperial'} ? ' btn-primary' : ' btn-outline'">
                                Imperial (ft/in, lb)
                            </button>
                        </form>
                    </div>

                    <!-- Height (conditional render) -->
                    <div class="field-container" th:if="${unitSystem != 'imperial'}">
                        <label class="field-label">
                            <i class="fas fa-ruler-vertical"></i>
                            Height (cm)
                        </label>
                        <div class="field-display" th:text="${heightCm != null ? heightCm : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="height">Edit</button>
                    </div>
                    <div class="field-container" th:if="${unitSystem == 'imperial'}">
                        <label class="field-label">
                            <i class="fas fa-ruler-vertical"></i>
                            Height (ft/in)
                        </label>
                        <div class="field-display" th:text="${(heightFeet != null and heightInches != null) ? heightFeet + 'ft ' + heightInches + 'in' : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="heightImperial">Edit</button>
                    </div>

                    <!-- Weight (conditional render) -->
                    <div class="field-container" th:if="${unitSystem != 'imperial'}">
                        <label class="field-label">
                            <i class="fas fa-weight"></i>
                            Weight (kg)
                        </label>
                        <div class="field-display" th:text="${weightKg != null ? weightKg : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="weight">Edit</button>
                    </div>
                    <div class="field-container" th:if="${unitSystem == 'imperial'}">
                        <label class="field-label">
                            <i class="fas fa-weight"></i>
                            Weight (lb)
                        </label>
                        <div class="field-display" th:text="${weightLbs != null ? weightLbs : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="weightLbs">Edit</button>
                    </div>

                    <!-- Goal -->
                    <div class="field-container">
                        <label class="field-label">
                            <i class="fas fa-bullseye"></i>
                            Goal
                        </label>
                        <div class="field-display" th:text="${goal != null ? (goal == 'LOSE_WEIGHT' ? 'Lose Weight' : (goal == 'MAINTAIN_WEIGHT' ? 'Maintain Weight' : (goal == 'GAIN_WEIGHT' ? 'Gain Weight' : goal))) : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="goal">Edit</button>
                    </div>

                    <!-- Desired Weight (shown if goal is not MAINTAIN_WEIGHT) -->
                    <div class="field-container" th:if="${goal != 'MAINTAIN_WEIGHT'}">
                        <label class="field-label">
                            <i class="fas fa-balance-scale"></i>
                            Desired Weight <span th:text="${unitSystem == 'imperial' ? '(lb)' : '(kg)'}">(kg)</span>
                        </label>
                        <div class="field-display" th:if="${unitSystem != 'imperial'}" th:text="${desiredWeightKg != null ? desiredWeightKg + ' kg' : 'Not set'}">Not set</div>
                        <div class="field-display" th:if="${unitSystem == 'imperial'}" th:text="${desiredWeightLbs != null ? desiredWeightLbs + ' lb' : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" th:data-field="${unitSystem == 'imperial' ? 'desiredWeightLbs' : 'desiredWeight'}">Edit</button>
                    </div>

                    <!-- Weight Change Speed (shown if goal is not MAINTAIN_WEIGHT) -->
                    <div class="field-container" th:if="${goal != 'MAINTAIN_WEIGHT'}">
                        <label class="field-label">
                            <i class="fas fa-tachometer-alt"></i>
                            Weight Change Speed <span th:text="${unitSystem == 'imperial' ? '(lb/week)' : '(kg/week)'}">(kg/week)</span>
                        </label>
                        <div class="field-display" th:if="${unitSystem != 'imperial'}" th:text="${weightChangeSpeedKg != null ? weightChangeSpeedKg + ' kg/week' : 'Not set'}">Not set</div>
                        <div class="field-display" th:if="${unitSystem == 'imperial'}" th:text="${weightChangeSpeedLbs != null ? weightChangeSpeedLbs + ' lb/week' : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" th:data-field="${unitSystem == 'imperial' ? 'weightSpeedLbs' : 'weightSpeed'}">Edit</button>
                    </div>

                    <!-- Workout Frequency -->
                    <div class="field-container">
                        <label class="field-label">
                            <i class="fas fa-calendar-check"></i>
                            Workout Frequency
                        </label>
                        <div class="field-display" th:text="${workoutFrequency != null ? workoutFrequency : 'Not set'}">Not set</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="workoutFrequency">Edit</button>
                    </div>

                    <!-- Timezone (IANA) -->
                    <div class="field-container">
                        <label class="field-label">
                            <i class="fas fa-globe"></i>
                            Timezone
                        </label>
                        <div class="field-display" th:text="${timezone != null ? timezone : 'UTC'}">UTC</div>
                        <button type="button" class="btn btn-secondary edit-field-btn" data-field="userTimezone">Edit</button>
                    </div>
                </div>

                <!-- Edit Modal -->
                <div id="editModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modalTitle">Edit Field</h3>
                            <button type="button" class="close-modal-btn" id="closeModalBtn">&times;</button>
                        </div>
                        <div class="modal-body" id="modalBody">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline cancel-btn" id="modalCancelBtn">Cancel</button>
                            <button type="button" class="btn btn-primary" id="modalSaveBtn">Save</button>
                        </div>
                    </div>
                </div>

                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-image"></i>
                            Profile Picture
                        </h2>
                    </div>

                    <div class="avatar-section">
                        
                        <div class="avatar-preview" th:if="${avatarPath}">
                            <img th:src="${avatarPath}" alt="Profile Picture" class="avatar-image">
                        </div>

                        <div class="avatar-preview" th:unless="${avatarPath}">
                            <div class="avatar-placeholder">
                                <i class="fas fa-user"></i>
                                <span>No profile picture</span>
                            </div>
                        </div>

                        
                        <form th:action="@{/settings/avatar-url}" method="post" class="avatar-form">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-link"></i>
                                Avatar Image URL
                            </label>
                            <div class="avatar-field-container">
                                <input type="url"
                                       name="avatarUrl"
                                       id="avatarUrlInput"
                                       class="form-input avatar-input"
                                       th:value="${avatarPath}"
                                       placeholder="https://example.com/your-image.jpg"
                                       readonly>
                                <button type="button" id="editAvatarBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                            <small class="form-help">Use a direct image URL (http/https).</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="saveAvatarBtn" class="btn btn-primary save-btn" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save URL
                            </button>
                            <button type="button" id="cancelAvatarBtn" class="btn btn-outline cancel-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>

                    
                    <div th:if="${avatarPath}" class="remove-avatar-section" id="removeAvatarSection" style="display: none;">
                        <form th:action="@{/settings/avatar/delete}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-outline btn-danger">
                                <i class="fas fa-trash"></i>
                                Remove Avatar
                            </button>
                        </form>
                    </div>
                    </div>
                </div>

                
                <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-lock"></i>
                            Change Password
                        </h2>
                    </div>

                    <div class="password-section">
                        <div class="password-field-container">
                            <div class="password-display">
                                <span class="password-mask">••••••••</span>
                                <button type="button" id="editPasswordBtn" class="btn btn-secondary edit-btn">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                            </div>
                        </div>
                        
                        <form th:action="@{/settings/password}" method="post" class="settings-form password-form" style="display: none;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-key"></i>
                                    Current Password
                                </label>
                                <input type="password" name="currentPassword" id="currentPasswordInput" class="form-input"
                                       placeholder="Enter current password" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-lock"></i>
                                    New Password
                                </label>
                                <input type="password" name="newPassword" id="newPasswordInput" class="form-input"
                                       placeholder="Enter new password" minlength="8" required>
                                <small class="form-help">Minimum 8 characters</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-lock"></i>
                                    Confirm New Password
                                </label>
                                <input type="password" name="confirmPassword" id="confirmPasswordInput" class="form-input"
                                       placeholder="Confirm new password" minlength="8" required>
                            </div>

                            <div class="form-actions">
                                <button type="submit" id="savePasswordBtn" class="btn btn-primary save-btn">
                                    <i class="fas fa-save"></i>
                                    Change Password
                                </button>
                                <button type="button" id="cancelPasswordBtn" class="btn btn-outline cancel-btn">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                            </div>
                        </form>
                        
                        <div class="password-edit-actions" style="display: none; margin-top: 1rem; text-align: center;">
                            <button type="button" id="cancelPasswordEditBtn" class="btn btn-outline cancel-btn">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>


                 <!-- Danger Zone -->
                 <div class="settings-section">
                    <div class="section-header">
                        <h2 class="section-title" style="color:#ff6b6b;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Danger Zone
                        </h2>
                    </div>

                    <div class="field-container">
                        <label class="field-label" style="color:#ff6b6b;">
                            <i class="fas fa-redo-alt"></i>
                            Reset Account
                        </label>
                        <div class="field-display" style="color:#ff9b9b;">
                            This will permanently remove your workouts, templates, schedules, rest days and custom exercises. Your profile information stays.
                        </div>
                        <button type="button" class="btn btn-outline" style="border-color:#ff6b6b;color:#ff6b6b;" id="openResetModalBtn">Reset Account</button>
                    </div>

                    <div class="field-container">
                        <label class="field-label" style="color:#ff4444;">
                            <i class="fas fa-user-slash"></i>
                            Delete Account
                        </label>
                        <div class="field-display" style="color:#ff9b9b;">
                            This will permanently delete your account and all related data. This action cannot be undone.
                        </div>
                        <button type="button" class="btn btn-outline" style="border-color:#ff4444;color:#ff4444;" id="openDeleteModalBtn">Delete Account</button>
                    </div>
                </div>

                <!-- Confirmation Modal for Danger Actions -->
                <div id="dangerModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="dangerModalTitle">Confirm Action</h3>
                            <button type="button" class="close-modal-btn" id="closeDangerModalBtn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p id="dangerModalText">
                                This action is permanent. To proceed, type <span class="confirm-phrase" id="dangerPhrase">delete account</span> below.
                            </p>
                            <input type="text" id="dangerConfirmInput" class="form-input" placeholder="Type the confirmation phrase">
                        </div>
                        <div class="modal-footer">
                            <form id="dangerForm" method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <input type="hidden" name="confirmText" id="dangerConfirmHidden" />
                                <button type="button" class="btn btn-outline" id="dangerCancelBtn">Cancel</button>
                                <button type="submit" class="btn btn-primary" id="dangerConfirmBtn" disabled>Confirm</button>
                            </form>
                        </div>
                    </div>
                </div>



                
            </div>
        </div>
    </main>
</div>

<!-- notifications script removed -->

<script>
// Function to show error messages in the UI
function showErrorMessage(message) {
    const form = document.querySelector('.settings-form');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'flash-message flash-error';
    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>' + message + '</span>';

    // Insert after the flash-messages div
    const flashMessages = document.querySelector('.flash-messages');
    flashMessages.appendChild(errorDiv);

    // Auto-hide after 5 seconds
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    const editBtn = document.getElementById('editUsernameBtn');
    const saveBtn = document.getElementById('saveUsernameBtn');
    const cancelBtn = document.getElementById('cancelUsernameBtn');
    const usernameInput = document.getElementById('usernameInput');
    const originalValue = usernameInput.value;

    // Edit button click handler
    editBtn.addEventListener('click', function() {
        // Enable input field
        usernameInput.removeAttribute('readonly');
        usernameInput.focus();
        
        // Show save and cancel buttons, hide edit button
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-flex';
        cancelBtn.style.display = 'inline-flex';
        
        // Add visual indication that field is editable
        usernameInput.classList.add('editing');
    });

    // Cancel button click handler
    cancelBtn.addEventListener('click', function() {
        // Restore original value
        usernameInput.value = originalValue;
        
        // Make input readonly again
        usernameInput.setAttribute('readonly', true);
        usernameInput.classList.remove('editing');
        
        // Show edit button, hide save and cancel buttons
        editBtn.style.display = 'inline-flex';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    });

    // Save button functionality (form submission)
    saveBtn.addEventListener('click', function(e) {
        // The form will submit normally since it's a submit button
        // Add any validation here if needed
        const newValue = usernameInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('Username cannot be empty');
            return;
        }
        if (newValue === originalValue) {
            e.preventDefault();
            showErrorMessage('No changes made');
            // Reset to edit mode
            cancelBtn.click();
            return;
        }
    });

    // Handle Enter key in input field
    usernameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !usernameInput.hasAttribute('readonly')) {
            e.preventDefault();
            saveBtn.click();
        }
        if (e.key === 'Escape' && !usernameInput.hasAttribute('readonly')) {
            e.preventDefault();
            cancelBtn.click();
        }
    });

    // Avatar functionality
    const editAvatarBtn = document.getElementById('editAvatarBtn');
    const saveAvatarBtn = document.getElementById('saveAvatarBtn');
    const cancelAvatarBtn = document.getElementById('cancelAvatarBtn');
    const avatarUrlInput = document.getElementById('avatarUrlInput');
    const originalAvatarValue = avatarUrlInput.value;

    editAvatarBtn.addEventListener('click', function() {
        avatarUrlInput.removeAttribute('readonly');
        avatarUrlInput.focus();
        
        editAvatarBtn.style.display = 'none';
        saveAvatarBtn.style.display = 'inline-flex';
        cancelAvatarBtn.style.display = 'inline-flex';
        
        // Show remove avatar button in edit mode
        const removeAvatarSection = document.getElementById('removeAvatarSection');
        if (removeAvatarSection) {
            removeAvatarSection.style.display = 'block';
        }
        
        avatarUrlInput.classList.add('editing');
    });

    cancelAvatarBtn.addEventListener('click', function() {
        avatarUrlInput.value = originalAvatarValue;
        avatarUrlInput.setAttribute('readonly', true);
        avatarUrlInput.classList.remove('editing');
        
        // Hide remove avatar button when canceling
        const removeAvatarSection = document.getElementById('removeAvatarSection');
        if (removeAvatarSection) {
            removeAvatarSection.style.display = 'none';
        }
        
        editAvatarBtn.style.display = 'inline-flex';
        saveAvatarBtn.style.display = 'none';
        cancelAvatarBtn.style.display = 'none';
    });

    saveAvatarBtn.addEventListener('click', function(e) {
        const newValue = avatarUrlInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('Avatar URL cannot be empty');
            return;
        }
        if (newValue === originalAvatarValue) {
            e.preventDefault();
            showErrorMessage('No changes made');
            cancelAvatarBtn.click();
            return;
        }
    });

    // Password functionality
    const editPasswordBtn = document.getElementById('editPasswordBtn');
    const savePasswordBtn = document.getElementById('savePasswordBtn');
    const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
    const cancelPasswordEditBtn = document.getElementById('cancelPasswordEditBtn');
    const passwordDisplay = document.querySelector('.password-display');
    const passwordForm = document.querySelector('.password-form');
    const passwordEditActions = document.querySelector('.password-edit-actions');

    editPasswordBtn.addEventListener('click', function() {
        passwordDisplay.style.display = 'none';
        passwordForm.style.display = 'block';
        passwordEditActions.style.display = 'block';
        
        document.getElementById('currentPasswordInput').focus();
    });

    cancelPasswordBtn.addEventListener('click', function() {
        passwordDisplay.style.display = 'block';
        passwordEditActions.style.display = 'none';
        passwordForm.style.display = 'none';
        
        // Clear form fields
        document.getElementById('currentPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
    });

    cancelPasswordEditBtn.addEventListener('click', function() {
        passwordDisplay.style.display = 'block';
        passwordEditActions.style.display = 'none';
        passwordForm.style.display = 'none';
        
        // Clear form fields
        document.getElementById('currentPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
    });

    savePasswordBtn.addEventListener('click', function(e) {
        const currentPassword = document.getElementById('currentPasswordInput').value.trim();
        const newPassword = document.getElementById('newPasswordInput').value.trim();
        const confirmPassword = document.getElementById('confirmPasswordInput').value.trim();

        if (currentPassword === '') {
            e.preventDefault();
            showErrorMessage('Current password is required');
            return;
        }
        if (newPassword === '') {
            e.preventDefault();
            showErrorMessage('New password is required');
            return;
        }
        if (newPassword.length < 8) {
            e.preventDefault();
            showErrorMessage('New password must be at least 8 characters long');
            return;
        }
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            showErrorMessage('New passwords do not match');
            return;
        }
    });

    // First Name functionality
    const editFirstNameBtn = document.getElementById('editFirstNameBtn');
    const saveFirstNameBtn = document.getElementById('saveFirstNameBtn');
    const cancelFirstNameBtn = document.getElementById('cancelFirstNameBtn');
    const firstNameInput = document.getElementById('firstNameInput');
    const originalFirstName = firstNameInput.value;

    editFirstNameBtn.addEventListener('click', function() {
        firstNameInput.removeAttribute('readonly');
        firstNameInput.focus();
        editFirstNameBtn.style.display = 'none';
        saveFirstNameBtn.style.display = 'inline-flex';
        cancelFirstNameBtn.style.display = 'inline-flex';
        firstNameInput.classList.add('editing');
    });

    cancelFirstNameBtn.addEventListener('click', function() {
        firstNameInput.value = originalFirstName;
        firstNameInput.setAttribute('readonly', true);
        firstNameInput.classList.remove('editing');
        editFirstNameBtn.style.display = 'inline-flex';
        saveFirstNameBtn.style.display = 'none';
        cancelFirstNameBtn.style.display = 'none';
    });

    saveFirstNameBtn.addEventListener('click', function(e) {
        const newValue = firstNameInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('First name cannot be empty');
            return;
        }
        if (newValue === originalFirstName) {
            e.preventDefault();
            showErrorMessage('No changes made');
            cancelFirstNameBtn.click();
            return;
        }
    });

    // Last Name functionality
    const editLastNameBtn = document.getElementById('editLastNameBtn');
    const saveLastNameBtn = document.getElementById('saveLastNameBtn');
    const cancelLastNameBtn = document.getElementById('cancelLastNameBtn');
    const lastNameInput = document.getElementById('lastNameInput');
    const originalLastName = lastNameInput.value;

    editLastNameBtn.addEventListener('click', function() {
        lastNameInput.removeAttribute('readonly');
        lastNameInput.focus();
        editLastNameBtn.style.display = 'none';
        saveLastNameBtn.style.display = 'inline-flex';
        cancelLastNameBtn.style.display = 'inline-flex';
        lastNameInput.classList.add('editing');
    });

    cancelLastNameBtn.addEventListener('click', function() {
        lastNameInput.value = originalLastName;
        lastNameInput.setAttribute('readonly', true);
        lastNameInput.classList.remove('editing');
        editLastNameBtn.style.display = 'inline-flex';
        saveLastNameBtn.style.display = 'none';
        cancelLastNameBtn.style.display = 'none';
    });

    saveLastNameBtn.addEventListener('click', function(e) {
        const newValue = lastNameInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('Last name cannot be empty');
            return;
        }
        if (newValue === originalLastName) {
            e.preventDefault();
            showErrorMessage('No changes made');
            cancelLastNameBtn.click();
            return;
        }
    });

    // Email functionality
    const editEmailBtn = document.getElementById('editEmailBtn');
    const saveEmailBtn = document.getElementById('saveEmailBtn');
    const cancelEmailBtn = document.getElementById('cancelEmailBtn');
    const emailInput = document.getElementById('emailInput');
    const originalEmail = emailInput.value;

    editEmailBtn.addEventListener('click', function() {
        emailInput.removeAttribute('readonly');
        emailInput.focus();
        editEmailBtn.style.display = 'none';
        saveEmailBtn.style.display = 'inline-flex';
        cancelEmailBtn.style.display = 'inline-flex';
        emailInput.classList.add('editing');
    });

    cancelEmailBtn.addEventListener('click', function() {
        emailInput.value = originalEmail;
        emailInput.setAttribute('readonly', true);
        emailInput.classList.remove('editing');
        editEmailBtn.style.display = 'inline-flex';
        saveEmailBtn.style.display = 'none';
        cancelEmailBtn.style.display = 'none';
    });

    saveEmailBtn.addEventListener('click', function(e) {
        const newValue = emailInput.value.trim();
        if (newValue === '') {
            e.preventDefault();
            showErrorMessage('Email cannot be empty');
            return;
        }
        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(newValue)) {
            e.preventDefault();
            showErrorMessage('Please enter a valid email address');
            return;
        }
        if (newValue === originalEmail) {
            e.preventDefault();
            showErrorMessage('No changes made');
            cancelEmailBtn.click();
            return;
        }
    });

    // Handle Enter key in email field
    emailInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !emailInput.hasAttribute('readonly')) {
            e.preventDefault();
            saveEmailBtn.click();
        }
        if (e.key === 'Escape' && !emailInput.hasAttribute('readonly')) {
            e.preventDefault();
            cancelEmailBtn.click();
        }
    });

    // Personal Information fields functionality
    const editModal = document.getElementById('editModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    let currentFieldType = null;
    let currentFieldContainer = null;
    let selectedValue = null;

    function openModal(fieldType, title, options) {
        currentFieldType = fieldType;
        modalTitle.textContent = title;
        modalBody.innerHTML = '';
        selectedValue = null;
        
        // Show modal footer
        document.querySelector('.modal-footer').style.display = 'flex';
        
        options.forEach(option => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'option-btn';
            button.textContent = option.label;
            button.value = option.value;
            button.addEventListener('click', function() {
                if (option.value === 'custom') {
                    showCustomInput(fieldType);
                } else {
                    selectedValue = option.value;
                    submitFieldUpdate();
                    closeModal();
                }
            });
            modalBody.appendChild(button);
        });
        
        editModal.style.display = 'block';
    }

    function selectOption(value) {
        submitFieldUpdate();
        closeModal();
    }

    function showCustomInput(fieldType) {
        let label = '';
        switch(fieldType) {
            case 'height': label = 'Enter your height (cm):'; break;
            case 'weight': label = 'Enter your weight (kg):'; break;
            case 'desiredWeight': label = 'Enter your desired weight (kg):'; break;
            case 'desiredWeightLbs': label = 'Enter your desired weight (lb):'; break;
            case 'weightSpeed': label = 'Enter weight change speed (kg/week):'; break;
            case 'weightSpeedLbs': label = 'Enter weight change speed (lb/week):'; break;
            case 'weightLbs': label = 'Enter your weight (lb):'; break;
        }
        
        modalBody.innerHTML = `
            <div class="custom-input-container">
                <label class="custom-input-label" th:remove="tag">${label}</label>
                <input type="text" id="customInput" class="form-input" placeholder="Enter value">
                <div class="custom-input-actions">
                    <button type="button" class="btn btn-outline" id="cancelCustomBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCustomBtn">Save</button>
                </div>
            </div>
        `;
        
        // Hide modal footer
        document.querySelector('.modal-footer').style.display = 'none';
        
        const customInput = document.getElementById('customInput');
        const saveCustomBtn = document.getElementById('saveCustomBtn');
        const cancelCustomBtn = document.getElementById('cancelCustomBtn');
        
        saveCustomBtn.addEventListener('click', function() {
            const value = customInput.value.trim();
            if (value !== '' && !isNaN(value)) {
                selectedValue = value;
                submitFieldUpdate();
                closeModal();
            }
        });
        
        cancelCustomBtn.addEventListener('click', function() {
            closeModal();
        });
        
        customInput.focus();
    }

    function closeModal() {
        editModal.style.display = 'none';
        modalBody.innerHTML = '';
        currentFieldType = null;
        currentFieldContainer = null;
    }

    modalCancelBtn.addEventListener('click', closeModal);
    closeModalBtn.addEventListener('click', closeModal);

    // Click outside modal to close
    editModal.addEventListener('click', function(e) {
        if (e.target === editModal) {
            closeModal();
        }
    });

    const editFieldBtns = document.querySelectorAll('.edit-field-btn');
    
    editFieldBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const fieldType = this.getAttribute('data-field');
            currentFieldContainer = this.closest('.field-container');
            
            switch(fieldType) {
                case 'height':
                    openModal(fieldType, 'Enter your height in cm', [
                        {label: '100 cm', value: '100'},
                        {label: '110 cm', value: '110'},
                        {label: '120 cm', value: '120'},
                        {label: '130 cm', value: '130'},
                        {label: '140 cm', value: '140'},
                        {label: '150 cm', value: '150'},
                        {label: '160 cm', value: '160'},
                        {label: '170 cm', value: '170'},
                        {label: '180 cm', value: '180'},
                        {label: '190 cm', value: '190'},
                        {label: '200 cm', value: '200'},
                        {label: '210 cm', value: '210'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'heightImperial':
                    // Dropdowns for feet/inches with optional custom inputs
                    currentFieldType = fieldType;
                    modalTitle.textContent = 'Enter your height (ft/in)';
                    modalBody.innerHTML = `
                        <div class="custom-input-container">
                            <div style="display:flex; gap:.5rem; align-items:flex-end; flex-wrap:wrap;">
                                <div>
                                    <label class="custom-input-label">Feet</label>
                                    <select id="feetSelect" class="form-input" style="min-width:110px;">
                                        <option value="" selected disabled>Select ft</option>
                                        <option value="4">4 ft</option>
                                        <option value="5">5 ft</option>
                                        <option value="6">6 ft</option>
                                        <option value="7">7 ft</option>
                                        <option value="custom">Custom…</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="custom-input-label">Inches</label>
                                    <select id="inchesSelect" class="form-input" style="min-width:110px;">
                                        <option value="" selected disabled>Select in</option>
                                        <option value="0">0 in</option>
                                        <option value="1">1 in</option>
                                        <option value="2">2 in</option>
                                        <option value="3">3 in</option>
                                        <option value="4">4 in</option>
                                        <option value="5">5 in</option>
                                        <option value="6">6 in</option>
                                        <option value="7">7 in</option>
                                        <option value="8">8 in</option>
                                        <option value="9">9 in</option>
                                        <option value="10">10 in</option>
                                        <option value="11">11 in</option>
                                        <option value="custom">Custom…</option>
                                    </select>
                                </div>
                                <div id="customFeetWrap" style="display:none;">
                                    <label class="custom-input-label">Custom feet</label>
                                    <input type="number" id="feetInput" class="form-input" min="1" max="9" step="1" placeholder="ft">
                                </div>
                                <div id="customInchesWrap" style="display:none;">
                                    <label class="custom-input-label">Custom inches</label>
                                    <input type="number" id="inchesInput" class="form-input" min="0" max="11" step="1" placeholder="in">
                                </div>
                            </div>
                        </div>
                    `;
                    document.querySelector('.modal-footer').style.display = 'flex';
                    editModal.style.display = 'block';
                    
                    // Wire up save button for heightImperial
                    modalSaveBtn.onclick = function() {
                        submitFieldUpdate();
                        closeModal();
                    };
                    
                    // Toggle custom inputs
                    (function(){
                        const feetSel = document.getElementById('feetSelect');
                        const inchSel = document.getElementById('inchesSelect');
                        const feetWrap = document.getElementById('customFeetWrap');
                        const inchWrap = document.getElementById('customInchesWrap');
                        if (feetSel) {
                            feetSel.addEventListener('change', ()=>{
                                feetWrap.style.display = (feetSel.value === 'custom') ? 'block' : 'none';
                            });
                        }
                        if (inchSel) {
                            inchSel.addEventListener('change', ()=>{
                                inchWrap.style.display = (inchSel.value === 'custom') ? 'block' : 'none';
                            });
                        }
                    })();
                    break;
                case 'weight':
                    openModal(fieldType, 'Enter your weight in kg', [
                        {label: '40 kg', value: '40'},
                        {label: '50 kg', value: '50'},
                        {label: '60 kg', value: '60'},
                        {label: '70 kg', value: '70'},
                        {label: '80 kg', value: '80'},
                        {label: '90 kg', value: '90'},
                        {label: '100 kg', value: '100'},
                        {label: '110 kg', value: '110'},
                        {label: '120 kg', value: '120'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'weightLbs':
                    openModal(fieldType, 'Enter your weight in lb', [
                        {label: '80 lb', value: '80'},
                        {label: '100 lb', value: '100'},
                        {label: '120 lb', value: '120'},
                        {label: '140 lb', value: '140'},
                        {label: '160 lb', value: '160'},
                        {label: '180 lb', value: '180'},
                        {label: '200 lb', value: '200'},
                        {label: '220 lb', value: '220'},
                        {label: '240 lb', value: '240'},
                        {label: '260 lb', value: '260'},
                        {label: '280 lb', value: '280'},
                        {label: '300 lb', value: '300'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'goal':
                    openModal(fieldType, 'Select your goal', [
                        {label: 'Lose Weight', value: 'LOSE_WEIGHT'},
                        {label: 'Maintain Weight', value: 'MAINTAIN_WEIGHT'},
                        {label: 'Gain Weight', value: 'GAIN_WEIGHT'}
                    ]);
                    break;
                case 'desiredWeight':
                    openModal(fieldType, 'Enter your desired weight in kg', [
                        {label: '50 kg', value: '50'},
                        {label: '60 kg', value: '60'},
                        {label: '70 kg', value: '70'},
                        {label: '80 kg', value: '80'},
                        {label: '90 kg', value: '90'},
                        {label: '100 kg', value: '100'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'desiredWeightLbs':
                    openModal(fieldType, 'Enter your desired weight in lb', [
                        {label: '110 lb', value: '110'},
                        {label: '130 lb', value: '130'},
                        {label: '150 lb', value: '150'},
                        {label: '170 lb', value: '170'},
                        {label: '190 lb', value: '190'},
                        {label: '210 lb', value: '210'},
                        {label: '230 lb', value: '230'},
                        {label: '250 lb', value: '250'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'weightSpeed':
                    openModal(fieldType, 'Enter your weight change speed in kg/week', [
                        {label: '0.1 kg/week', value: '0.1'},
                        {label: '0.2 kg/week', value: '0.2'},
                        {label: '0.3 kg/week', value: '0.3'},
                        {label: '0.4 kg/week', value: '0.4'},
                        {label: '0.5 kg/week', value: '0.5'},
                        {label: '0.6 kg/week', value: '0.6'},
                        {label: '0.7 kg/week', value: '0.7'},
                        {label: '0.8 kg/week', value: '0.8'},
                        {label: '0.9 kg/week', value: '0.9'},
                        {label: '1.0 kg/week', value: '1.0'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'weightSpeedLbs':
                    openModal(fieldType, 'Enter your weight change speed in lb/week', [
                        {label: '0.2 lb/week', value: '0.2'},
                        {label: '0.4 lb/week', value: '0.4'},
                        {label: '0.6 lb/week', value: '0.6'},
                        {label: '0.8 lb/week', value: '0.8'},
                        {label: '1.0 lb/week', value: '1.0'},
                        {label: '1.2 lb/week', value: '1.2'},
                        {label: '1.4 lb/week', value: '1.4'},
                        {label: '1.6 lb/week', value: '1.6'},
                        {label: '1.8 lb/week', value: '1.8'},
                        {label: '2.0 lb/week', value: '2.0'},
                        {label: 'Custom...', value: 'custom'}
                    ]);
                    break;
                case 'workoutFrequency':
                    openModal(fieldType, 'Select workout frequency', [
                        {label: 'Low (0-2 days/week)', value: 'LOW'},
                        {label: 'Medium (3-5 days/week)', value: 'MEDIUM'},
                        {label: 'High (6 days/week)', value: 'HIGH'},
                        {label: 'Dedicated Athlete (7+ days/week)', value: 'ATHLETE'}
                    ]);
                    break;
                case 'userTimezone':
                    // IANA timezone selector with search
                    currentFieldType = fieldType;
                    modalTitle.textContent = 'Select your timezone';
                    modalBody.innerHTML = `
                        <style>
                            /* Eliminate duplicate vertical line near the scrollbar in the timezone list */
                            #timezoneList {
                                border: none !important;
                                box-shadow: none !important;
                                outline: none !important;
                                border-right: none !important;
                                scrollbar-width: thin; /* Firefox */
                                scrollbar-color: rgba(255,255,255,0.25) transparent; /* Firefox */
                            }
                            #timezoneList .option-btn { border: none; background: transparent; }
                            #timezoneList .option-btn + .option-btn { border-top: 1px solid rgba(255,255,255,0.08); }
                            /* WebKit scrollbars */
                            #timezoneList::-webkit-scrollbar { width: 8px; background: transparent; }
                            #timezoneList::-webkit-scrollbar-track { background: transparent; border-left: none !important; box-shadow: none !important; }
                            #timezoneList::-webkit-scrollbar-thumb {
                                background-color: rgba(255,255,255,0.25);
                                border-radius: 6px;
                                border: 2px solid transparent; /* avoid left-side line illusion */
                                background-clip: padding-box;
                            }
                        </style>
                        <div class="custom-input-container">
                            <input type="text" id="timezoneSearch" class="form-input" placeholder="Search timezone (e.g., Madrid, New York, Tokyo)" style="margin-bottom: 0.75rem;">
                            <div id="timezoneList" style="max-height: 300px; overflow-y: auto; border: none; border-radius: 8px; padding: 0.5rem;">
                                <!-- Timezones will be populated here -->
                            </div>
                        </div>
                    `;
                    document.querySelector('.modal-footer').style.display = 'flex';
                    editModal.style.display = 'block';
                    
                    // Comprehensive IANA timezones organized by region
                    const timezones = [
                        // Europe
                        {label: 'Europe/London (GMT/BST)', value: 'Europe/London'},
                        {label: 'Europe/Dublin (GMT/IST)', value: 'Europe/Dublin'},
                        {label: 'Europe/Lisbon (WET/WEST)', value: 'Europe/Lisbon'},
                        {label: 'Europe/Paris (CET/CEST)', value: 'Europe/Paris'},
                        {label: 'Europe/Madrid (CET/CEST)', value: 'Europe/Madrid'},
                        {label: 'Europe/Berlin (CET/CEST)', value: 'Europe/Berlin'},
                        {label: 'Europe/Rome (CET/CEST)', value: 'Europe/Rome'},
                        {label: 'Europe/Amsterdam (CET/CEST)', value: 'Europe/Amsterdam'},
                        {label: 'Europe/Brussels (CET/CEST)', value: 'Europe/Brussels'},
                        {label: 'Europe/Vienna (CET/CEST)', value: 'Europe/Vienna'},
                        {label: 'Europe/Prague (CET/CEST)', value: 'Europe/Prague'},
                        {label: 'Europe/Warsaw (CET/CEST)', value: 'Europe/Warsaw'},
                        {label: 'Europe/Stockholm (CET/CEST)', value: 'Europe/Stockholm'},
                        {label: 'Europe/Copenhagen (CET/CEST)', value: 'Europe/Copenhagen'},
                        {label: 'Europe/Oslo (CET/CEST)', value: 'Europe/Oslo'},
                        {label: 'Europe/Helsinki (EET/EEST)', value: 'Europe/Helsinki'},
                        {label: 'Europe/Athens (EET/EEST)', value: 'Europe/Athens'},
                        {label: 'Europe/Sofia (EET/EEST)', value: 'Europe/Sofia'},
                        {label: 'Europe/Bucharest (EET/EEST)', value: 'Europe/Bucharest'},
                        {label: 'Europe/Budapest (CET/CEST)', value: 'Europe/Budapest'},
                        {label: 'Europe/Istanbul (TRT)', value: 'Europe/Istanbul'},
                        {label: 'Europe/Moscow (MSK)', value: 'Europe/Moscow'},
                        {label: 'Europe/Kiev (EET/EEST)', value: 'Europe/Kiev'},
                        // North America
                        {label: 'America/New_York (EST/EDT)', value: 'America/New_York'},
                        {label: 'America/Chicago (CST/CDT)', value: 'America/Chicago'},
                        {label: 'America/Denver (MST/MDT)', value: 'America/Denver'},
                        {label: 'America/Los_Angeles (PST/PDT)', value: 'America/Los_Angeles'},
                        {label: 'America/Toronto (EST/EDT)', value: 'America/Toronto'},
                        {label: 'America/Vancouver (PST/PDT)', value: 'America/Vancouver'},
                        {label: 'America/Montreal (EST/EDT)', value: 'America/Montreal'},
                        {label: 'America/Mexico_City (CST)', value: 'America/Mexico_City'},
                        {label: 'America/Phoenix (MST)', value: 'America/Phoenix'},
                        {label: 'America/Seattle (PST/PDT)', value: 'America/Seattle'},
                        {label: 'America/Dallas (CST/CDT)', value: 'America/Dallas'},
                        {label: 'America/Houston (CST/CDT)', value: 'America/Houston'},
                        {label: 'America/Miami (EST/EDT)', value: 'America/Miami'},
                        {label: 'America/Boston (EST/EDT)', value: 'America/Boston'},
                        {label: 'America/Anchorage (AKST/AKDT)', value: 'America/Anchorage'},
                        {label: 'Pacific/Honolulu (HST)', value: 'Pacific/Honolulu'},
                        // Asia
                        {label: 'Asia/Tokyo (JST)', value: 'Asia/Tokyo'},
                        {label: 'Asia/Seoul (KST)', value: 'Asia/Seoul'},
                        {label: 'Asia/Shanghai (CST)', value: 'Asia/Shanghai'},
                        {label: 'Asia/Beijing (CST)', value: 'Asia/Beijing'},
                        {label: 'Asia/Hong_Kong (HKT)', value: 'Asia/Hong_Kong'},
                        {label: 'Asia/Taipei (CST)', value: 'Asia/Taipei'},
                        {label: 'Asia/Singapore (SGT)', value: 'Asia/Singapore'},
                        {label: 'Asia/Bangkok (ICT)', value: 'Asia/Bangkok'},
                        {label: 'Asia/Jakarta (WIB)', value: 'Asia/Jakarta'},
                        {label: 'Asia/Manila (PHT)', value: 'Asia/Manila'},
                        {label: 'Asia/Kuala_Lumpur (MYT)', value: 'Asia/Kuala_Lumpur'},
                        {label: 'Asia/Dubai (GST)', value: 'Asia/Dubai'},
                        {label: 'Asia/Riyadh (AST)', value: 'Asia/Riyadh'},
                        {label: 'Asia/Tehran (IRST)', value: 'Asia/Tehran'},
                        {label: 'Asia/Kolkata (IST)', value: 'Asia/Kolkata'},
                        {label: 'Asia/Mumbai (IST)', value: 'Asia/Mumbai'},
                        {label: 'Asia/Delhi (IST)', value: 'Asia/Delhi'},
                        {label: 'Asia/Karachi (PKT)', value: 'Asia/Karachi'},
                        {label: 'Asia/Dhaka (BST)', value: 'Asia/Dhaka'},
                        {label: 'Asia/Colombo (IST)', value: 'Asia/Colombo'},
                        {label: 'Asia/Kathmandu (NPT)', value: 'Asia/Kathmandu'},
                        {label: 'Asia/Jerusalem (IST/IDT)', value: 'Asia/Jerusalem'},
                        // Oceania
                        {label: 'Australia/Sydney (AEST/AEDT)', value: 'Australia/Sydney'},
                        {label: 'Australia/Melbourne (AEST/AEDT)', value: 'Australia/Melbourne'},
                        {label: 'Australia/Brisbane (AEST)', value: 'Australia/Brisbane'},
                        {label: 'Australia/Perth (AWST)', value: 'Australia/Perth'},
                        {label: 'Australia/Adelaide (ACST/ACDT)', value: 'Australia/Adelaide'},
                        {label: 'Pacific/Auckland (NZST/NZDT)', value: 'Pacific/Auckland'},
                        {label: 'Pacific/Fiji (FJT)', value: 'Pacific/Fiji'},
                        // South America
                        {label: 'America/Sao_Paulo (BRT)', value: 'America/Sao_Paulo'},
                        {label: 'America/Buenos_Aires (ART)', value: 'America/Buenos_Aires'},
                        {label: 'America/Lima (PET)', value: 'America/Lima'},
                        {label: 'America/Bogota (COT)', value: 'America/Bogota'},
                        {label: 'America/Santiago (CLT)', value: 'America/Santiago'},
                        {label: 'America/Caracas (VET)', value: 'America/Caracas'},
                        {label: 'America/Rio_de_Janeiro (BRT)', value: 'America/Rio_de_Janeiro'},
                        // Africa
                        {label: 'Africa/Johannesburg (SAST)', value: 'Africa/Johannesburg'},
                        {label: 'Africa/Cairo (EET)', value: 'Africa/Cairo'},
                        {label: 'Africa/Lagos (WAT)', value: 'Africa/Lagos'},
                        {label: 'Africa/Nairobi (EAT)', value: 'Africa/Nairobi'},
                        {label: 'Africa/Casablanca (WET)', value: 'Africa/Casablanca'},
                        {label: 'Africa/Addis_Ababa (EAT)', value: 'Africa/Addis_Ababa'},
                        {label: 'Africa/Dar_es_Salaam (EAT)', value: 'Africa/Dar_es_Salaam'},
                        // UTC
                        {label: 'UTC', value: 'UTC'}
                    ];
                    
                    const timezoneList = document.getElementById('timezoneList');
                    const searchInput = document.getElementById('timezoneSearch');
                    let filteredTimezones = timezones;
                    
                    function renderTimezones(tzList) {
                        timezoneList.innerHTML = '';
                        tzList.forEach(tz => {
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'option-btn';
                            btn.textContent = tz.label;
                            btn.value = tz.value;
                            btn.style.width = '100%';
                            btn.style.textAlign = 'left';
                            btn.style.marginBottom = '0.25rem';
                            btn.addEventListener('click', function() {
                                selectedValue = tz.value;
                                submitFieldUpdate();
                                closeModal();
                            });
                            timezoneList.appendChild(btn);
                        });
                    }
                    
                    renderTimezones(timezones);
                    
                    searchInput.addEventListener('input', function() {
                        const query = this.value.toLowerCase();
                        filteredTimezones = timezones.filter(tz => 
                            tz.label.toLowerCase().includes(query) || 
                            tz.value.toLowerCase().includes(query)
                        );
                        renderTimezones(filteredTimezones);
                    });
                    
                    break;
            }
        });
    });

    function submitFieldUpdate() {
        let url, paramName, paramValue;
        
        switch(currentFieldType) {
            case 'height':
                url = '/settings/update-height';
                paramName = 'heightCm';
                paramValue = parseInt(selectedValue);
                break;
            case 'heightImperial':
                url = '/settings/update-height-imperial';
                paramName = null; // we'll post feet and inches
                break;
            case 'weight':
                url = '/settings/update-weight';
                paramName = 'weightKg';
                paramValue = parseInt(selectedValue);
                break;
            case 'weightLbs':
                url = '/settings/update-weight-lbs';
                paramName = 'weightLbs';
                // If custom was selected, get from custom input, otherwise use selectedValue
                if (selectedValue === 'custom') {
                    const customInput = document.getElementById('customInput');
                    paramValue = customInput ? parseInt(customInput.value) : null;
                } else {
                    paramValue = parseInt(selectedValue);
                }
                break;
            case 'goal':
                url = '/settings/update-goal';
                paramName = 'goal';
                paramValue = selectedValue;
                break;
            case 'desiredWeight':
                url = '/settings/update-desired-weight';
                paramName = 'desiredWeightKg';
                if (selectedValue === 'custom') {
                    const customInput = document.getElementById('customInput');
                    paramValue = customInput ? parseInt(customInput.value) : null;
                } else {
                paramValue = parseInt(selectedValue);
                }
                break;
            case 'desiredWeightLbs':
                url = '/settings/update-desired-weight-lbs';
                paramName = 'desiredWeightLbs';
                if (selectedValue === 'custom') {
                    const customInput = document.getElementById('customInput');
                    paramValue = customInput ? parseInt(customInput.value) : null;
                } else {
                    paramValue = parseInt(selectedValue);
                }
                break;
            case 'weightSpeed':
                url = '/settings/update-weight-speed';
                paramName = 'weightChangeSpeedKg';
                if (selectedValue === 'custom') {
                    const customInput = document.getElementById('customInput');
                    paramValue = customInput ? parseFloat(customInput.value) : null;
                } else {
                paramValue = parseFloat(selectedValue);
                }
                break;
            case 'weightSpeedLbs':
                url = '/settings/update-weight-speed-lbs';
                paramName = 'weightChangeSpeedLbs';
                if (selectedValue === 'custom') {
                    const customInput = document.getElementById('customInput');
                    paramValue = customInput ? parseFloat(customInput.value) : null;
                } else {
                    paramValue = parseFloat(selectedValue);
                }
                break;
            case 'workoutFrequency':
                url = '/settings/update-workout-frequency';
                paramName = 'workoutFrequency';
                paramValue = selectedValue;
                break;
            case 'userTimezone':
                url = '/settings/update-user-timezone';
                paramName = 'timezone';
                paramValue = selectedValue;
                break;
            default:
                return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = url;
        
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = document.querySelector('meta[name="_csrf_parameter"]').getAttribute('content');
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        if (currentFieldType === 'heightImperial') {
            // Prefer selected values; if custom chosen, read from custom inputs
            let feetSel = document.getElementById('feetSelect');
            let inchSel = document.getElementById('inchesSelect');
            let feetVal = feetSel ? feetSel.value : '';
            let inchVal = inchSel ? inchSel.value : '';
            if (feetVal === 'custom' || feetVal === '' || feetVal == null) {
                feetVal = document.getElementById('feetInput') ? document.getElementById('feetInput').value : '';
            }
            if (inchVal === 'custom' || inchVal === '' || inchVal == null) {
                inchVal = document.getElementById('inchesInput') ? document.getElementById('inchesInput').value : '';
            }
            const feet = parseInt(feetVal);
            const inches = parseInt(inchVal);
            const feetInput = document.createElement('input');
            feetInput.type = 'hidden';
            feetInput.name = 'heightFeet';
            feetInput.value = feet;
            form.appendChild(feetInput);
            const inchesInput = document.createElement('input');
            inchesInput.type = 'hidden';
            inchesInput.name = 'heightInches';
            inchesInput.value = inches;
            form.appendChild(inchesInput);
        } else {
        const valueInput = document.createElement('input');
        valueInput.type = 'hidden';
        valueInput.name = paramName;
        valueInput.value = paramValue;
        form.appendChild(valueInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
    
    // Prevent overscrolling by clamping scroll position
    function clampScrollPosition() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = Math.max(
            document.body.scrollHeight,
            document.body.offsetHeight,
            document.documentElement.clientHeight,
            document.documentElement.scrollHeight,
            document.documentElement.offsetHeight
        );
        const clientHeight = window.innerHeight || document.documentElement.clientHeight;
        const maxScroll = Math.max(0, scrollHeight - clientHeight);
        
        if (scrollTop < 0) {
            window.scrollTo(0, 0);
        } else if (scrollTop > maxScroll) {
            window.scrollTo(0, maxScroll);
        }
    }
    
    let scrollTimeout;
    function handleScroll() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(clampScrollPosition, 10);
    }
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('touchmove', handleScroll, { passive: true });
    window.addEventListener('wheel', handleScroll, { passive: true });
    
    document.addEventListener('DOMContentLoaded', function() {
        clampScrollPosition();
        window.addEventListener('resize', function() {
            setTimeout(clampScrollPosition, 100);
        });
    });

    // Danger modal logic
    const openResetModalBtn = document.getElementById('openResetModalBtn');
    const openDeleteModalBtn = document.getElementById('openDeleteModalBtn');
    const dangerModal = document.getElementById('dangerModal');
    const closeDangerModalBtn = document.getElementById('closeDangerModalBtn');
    const dangerModalTitle = document.getElementById('dangerModalTitle');
    const dangerModalText = document.getElementById('dangerModalText');
    const dangerConfirmInput = document.getElementById('dangerConfirmInput');
    const dangerConfirmBtn = document.getElementById('dangerConfirmBtn');
    const dangerCancelBtn = document.getElementById('dangerCancelBtn');
    const dangerForm = document.getElementById('dangerForm');
    const dangerConfirmHidden = document.getElementById('dangerConfirmHidden');

    function openDanger(action) {
        const isDelete = action === 'delete';
        dangerModalTitle.textContent = isDelete ? 'Delete Account' : 'Reset Account';
        const phrase = isDelete ? 'delete account' : 'reset account';
        dangerModalText.innerHTML = `This action is permanent. To proceed, type <span class="confirm-phrase" id="dangerPhrase">${phrase}</span> below.`;
        dangerForm.action = isDelete ? '/settings/delete-account' : '/settings/reset-account';
        dangerConfirmInput.value = '';
        dangerConfirmHidden.value = '';
        dangerConfirmBtn.disabled = true;
        dangerModal.style.display = 'block';
        dangerConfirmInput.focus();
        // live validation
        const onInput = () => {
            const val = dangerConfirmInput.value.trim().toLowerCase();
            dangerConfirmBtn.disabled = (val !== phrase);
            dangerConfirmHidden.value = dangerConfirmInput.value;
        };
        dangerConfirmInput.removeEventListener('input', onInput);
        dangerConfirmInput.addEventListener('input', onInput);
    }

    if (openResetModalBtn) openResetModalBtn.addEventListener('click', () => openDanger('reset'));
    if (openDeleteModalBtn) openDeleteModalBtn.addEventListener('click', () => openDanger('delete'));
    if (closeDangerModalBtn) closeDangerModalBtn.addEventListener('click', () => { dangerModal.style.display='none'; });
    if (dangerCancelBtn) dangerCancelBtn.addEventListener('click', () => { dangerModal.style.display='none'; });
});
</script>

</body>
</html>